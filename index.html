<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Insertar T√≠tulo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Import html2canvas and jsPDF libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Import Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base styles for Inter font and pastel background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f3f7; /* Pastel light purple */
            color: #333;
        }
        /* Container for overall layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.25rem; /* Equivalent to p-5 */
        }
        /* Header section styling */
        .header {
            background-color: #e0b0d0; /* Pastel pink */
            padding: 1.25rem; /* Equivalent to p-5 */
            border-radius: 0.9375rem; /* Equivalent to rounded-xl */
            margin-bottom: 1.875rem; /* Equivalent to mb-8 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative; /* For positioning the settings icon */
            text-align: center; /* Center align content within the header */
        }
        /* Settings icon styling */
        .settings-icon, .share-icon { /* Combined styling for both icons */
            position: absolute;
            top: 0.5rem; /* Adjusted for a small space from the top */
            cursor: pointer;
            font-size: 1.5rem;
            color: #666;
            transition: color 0.2s ease;
            z-index: 10; /* Ensure it's above other elements */
        }
        .settings-icon {
            left: 0.5rem; /* Adjusted for a small space from the left */
        }
        .share-icon {
            right: 0.5rem; /* Adjusted for a small space from the right */
        }
        .settings-icon:hover, .share-icon:hover {
            color: #333;
        }
        /* Career title styling to prevent overlap and allow breaking long words */
        #careerTitleDisplay {
            word-break: break-word; /* Allows long words to break and wrap */
            hyphens: auto; /* Enables automatic hyphenation if supported by browser */
            padding-left: 3rem; /* Ensure space for the settings icon */
            padding-right: 3rem; /* For symmetrical padding */
            margin-top: 0;
            margin-bottom: 0;
            line-height: 1.2; /* Adjust line height for better wrapping */
        }

        /* Progress bar container styling */
        .progress-bar-container {
            background-color: #f0e0f0; /* Lighter pastel pink */
            border-radius: 0.625rem; /* Equivalent to rounded-lg */
            height: 1.5625rem; /* Equivalent to h-6 */
            overflow: hidden;
            margin-top: 0.625rem; /* Equivalent to mt-2 */
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        /* Individual progress bar styling */
        .progress-bar {
            height: 100%;
            background-color: #a0d0b0; /* Pastel green */
            border-radius: 0.625rem; /* Equivalent to rounded-lg */
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 1.5625rem; /* Match height for vertical centering */
            transition: width 0.5s ease-in-out; /* Smooth width transition */
        }
        /* Year selection buttons container */
        .year-selection-buttons {
            display: flex;
            justify-content: center;
            gap: 0.9375rem; /* Equivalent to gap-4 */
            margin-bottom: 1.875rem; /* Equivalent to mb-8 */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        /* Styling for individual year buttons */
        .year-button {
            background-color: #c0e0d0; /* Pastel green */
            color: #333;
            padding: 0.75rem 1.5625rem; /* Equivalent to py-3 px-6 */
            border-radius: 0.625rem; /* Equivalent to rounded-lg */
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        .year-button:hover {
            background-color: #a0d0b0; /* Darker pastel green */
            transform: translateY(-2px); /* Slight lift on hover */
        }
        /* New: Styling for completed and incomplete years */
        .year-button.year-incomplete {
            background-color: #e0e0e0; /* Light gray for incomplete */
            color: #666; /* Darker text for readability */
            border: 1px solid #c0c0c0;
        }
        .year-button.year-incomplete:hover {
            background-color: #d0d0d0; /* Slightly darker gray on hover */
        }
        .year-button.year-completed {
            background-color: #70a080; /* Distinct pastel green for completed */
            color: white;
            border: 1px solid #508060;
        }
        .year-button.year-completed:hover {
            background-color: #508060; /* Darker green on hover */
        }
        .year-button.active {
            background-color: #80b090; /* Even darker pastel green for active state */
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* New: Styling for the main calendar button */
        .calendar-main-button {
            background-color: #b0e0e6; /* Pastel light blue */
            color: #333;
            padding: 0.75rem 1.5625rem;
            border-radius: 0.625rem;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            /* New: Margin top to connect with the header, and full width */
            margin-top: 1rem; /* Adjust as needed for visual connection */
            width: calc(100% - 2.5rem); /* Full width minus padding of container (1.25rem * 2) */
            margin-left: 1.25rem; /* Align with container padding */
            margin-right: 1.25rem; /* Align with container padding */
        }
        .calendar-main-button:hover {
            background-color: #80c0c6; /* Darker pastel blue */
            transform: translateY(-2px);
        }
        .calendar-main-button.active {
            background-color: #60a0a6; /* Even darker pastel blue for active state */
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }


        /* Semester section styling */
        .semester-section {
            background-color: #fff;
            border-radius: 0.9375rem; /* Equivalent to rounded-xl */
            padding: 1.5625rem; /* Equivalent to p-6 */
            margin-bottom: 1.875rem; /* Equivalent to mb-8 */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        /* Individual subject item styling */
        .subject-item {
            display: flex; /* Use flexbox */
            align-items: flex-start; /* Align checkbox with the top of the details */
            margin-bottom: 0.625rem; /* Equivalent to mb-2.5 */
            padding: 0.5rem 0.75rem; /* Added horizontal padding for background color */
            padding-right: 3rem; /* Increased padding to make space for fixed icons */
            border-radius: 0.3125rem; /* Rounded corners for background */
            transition: background-color 0.2s ease; /* Smooth hover effect */
            position: relative; /* Needed for absolute positioning of the icons container */
            flex-wrap: wrap; /* Allow content to wrap on smaller screens */
        }
        .subject-item:last-child {
            border-bottom: none; /* No border for the last item */
        }
        .subject-item:hover {
            filter: brightness(95%); /* Slightly darken on hover */
        }
        /* Checkbox styling */
        .subject-checkbox {
            margin-right: 0.9375rem; /* Equivalent to mr-4 */
            width: 1.25rem; /* Equivalent to w-5 */
            height: 1.25rem; /* Equivalent to h-5 */
            accent-color: #a0d0b0; /* Pastel green accent color */
            cursor: pointer;
        }

        /* New: Subject Details Container (for name and credits) */
        .subject-details {
            display: flex;
            flex-direction: column; /* Stack name and credits vertically */
            flex-grow: 1; /* Allow it to take available space */
            margin-right: 0.75rem; /* Space before tags */
        }

        /* Subject name styling to prevent overlap and allow breaking long words */
        .subject-name {
            font-size: 1.1em;
            color: #555;
            cursor: pointer; /* Only the name is clickable for edit */
            max-width: 15ch; /* Limit width to approximately 15 characters, forcing wrap */
            overflow-wrap: break-word; /* Break long words if they overflow */
            hyphens: auto; /* Add hyphens where words break */
            /* margin-right: 0.75rem; REMOVED, handled by parent .subject-details */
        }
        .subject-name.completed {
            text-decoration: line-through;
            color: #999;
        }
        /* Subject credits and schedule code styling - now stacked below name */
        .subject-credits-and-code {
            display: flex; /* Use flexbox for credits and code */
            align-items: center; /* Align them vertically */
            gap: 0.5rem; /* Space between credits and code */
            font-weight: 500;
            color: #777;
            font-size: 0.9em; /* Slightly smaller for credits and code */
        }
        .subject-schedule-code {
            padding: 0.125rem 0.375rem;
            border-radius: 0.3125rem;
            font-size: 0.8em; /* Even smaller for the code tag */
            color: #333;
            font-weight: 600;
            /* Removed fixed background-color to allow dynamic assignment */
        }


        /* New: Subject Tags Container (for type and delivery type) */
        .subject-tags {
            display: flex;
            flex-direction: column; /* Stack type and delivery type vertically */
            align-items: flex-start; /* Align tags to the left within their column */
            margin-right: 0.75rem; /* Space before icons container */
        }
        .subject-type, .delivery-type {
            font-size: 0.9em;
            font-weight: 500;
            padding: 0.125rem 0.375rem; /* Equivalent to py-0.5 px-1.5 */
            border-radius: 0.3125rem; /* Equivalent to rounded-md */
            margin-right: 0; /* Remove individual right margins */
            margin-bottom: 0.25rem; /* Small space between stacked tags */
        }
        .delivery-type {
            margin-top: 0; /* Remove previous margin-top */
        }

        /* New: Icons Container */
        .subject-icons {
            position: absolute; /* Fixed relative to subject-item */
            top: 0.5rem; /* Position from top */
            right: 0.5rem; /* Position from right */
            display: flex;
            gap: 0.5rem; /* Space between the two icons */
            z-index: 20; /* Ensure it's on top */
        }
        /* Individual icon styling within the container */
        .subject-icons .grade-status-trigger,
        .subject-icons .subject-info-trigger {
            cursor: pointer;
            font-size: 1.2em;
            color: #666;
            transition: color 0.2s ease;
            padding: 0.25rem; /* Increase clickable area */
            background-color: rgba(255, 255, 255, 0.5); /* Subtle background */
            border-radius: 0.3125rem; /* Rounded corners */
            margin-left: 0; /* Reset margin */
        }

        .subject-icons .grade-status-trigger:hover,
        .subject-icons .subject-info-trigger:hover {
            color: #333;
        }


        /* Schedule table styling */
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.25rem; /* Equivalent to mt-5 */
            background-color: #fce8f0; /* Very light pastel pink for schedule */
            border-radius: 0.625rem; /* Equivalent to rounded-lg */
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #f0e0f0; /* Lighter pastel pink border */
            padding: 0.5rem; /* Equivalent to p-2 */
            text-align: center;
            vertical-align: top;
        }
        .schedule-table th {
            background-color: #d0e0f0; /* Pastel blue */
            color: #333;
            font-weight: 600;
            padding: 0.75rem 0.5rem; /* Equivalent to py-3 px-2 */
        }
        .schedule-table td {
            min-width: 6.25rem; /* Adjusted for smaller screens */
            background-color: #f7f3f7; /* Pastel light purple */
        }
        .schedule-time {
            background-color: #f0e0f0; /* Lighter pastel pink */
            font-weight: 500;
            color: #555;
        }
        /* Styling for individual schedule entries */
        .schedule-entry {
            border-radius: 0.3125rem; /* Equivalent to rounded-md */
            padding: 0.25rem; /* Equivalent to p-1 */
            margin: 0.125rem 0; /* Equivalent to my-0.5 */
            font-size: 0.85em; /* Smaller font for schedule entries */
            line-height: 1.2;
            color: #333;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            text-align: center; /* Centered text as requested */
        }
        /* MODIFIED: Only text color for overlap, no background */
        .schedule-entry.overlap {
            color: #8b0000; /* Dark red for text */
            font-weight: bold;
        }
        .hidden {
            display: none;
        }

        /* --- Custom Pastel Colors for Subject Types --- */
        /* Obligatoria - Pastel Orange */
        .subject-item.type-Obligatoria {
            background-color: #ffe0b0; /* Light pastel orange */
        }
        .schedule-entry.type-Obligatoria {
            background-color: #ffc080; /* Slightly darker pastel orange */
        }
        .subject-type.type-Obligatoria {
            background-color: #ffb060; /* Even darker for the tag */
            color: #4a2a00;
        }

        /* Opcional - Pastel Green */
        .subject-item.type-Opcional {
            background-color: #e0f7e0; /* Light pastel green */
        }
        .schedule-entry.type-Opcional {
            background-color: #c0e0c0; /* Slightly darker pastel green */
        }
        .subject-type.type-Opcional {
            background-color: #a0d0a0; /* Even darker for the tag */
            color: #004a00;
        }

        /* Electiva - Pastel Pink */
        .subject-item.type-Electiva {
            background-color: #fce4ec; /* Light pastel pink */
        }
        .schedule-entry.type-Electiva {
            background-color: #f8bbd0; /* Slightly darker pastel pink */
        }
        .subject-type.type-Electiva {
            background-color: #f48fb1; /* Even darker for the tag */
            color: #4a002a;
        }

        /* --- Custom Pastel Colors for Delivery Types --- */
        .delivery-type.delivery-type-Presencial {
            background-color: #e0f2f7; /* Light pastel blue */
            color: #00334d;
        }
        .delivery-type.delivery-type-ADistancia {
            background-color: #fff9e6; /* Light pastel yellow */
            color: #4d4000;
        }
        /* New: Hibrida - Pastel Purple */
        .delivery-type.delivery-type-Hibrida {
            background-color: #e6e0f7; /* Light pastel purple */
            color: #33004d;
        }


        /* Modal specific styles */
        .modal-content {
            max-height: 80vh; /* Limit modal height */
            overflow-y: auto; /* Enable scrolling for modal content */
        }

        /* Semester Credits Total Styling */
        .semester-credits-total {
            margin-top: 1.25rem; /* Equivalent to mt-5 */
            padding-top: 0.75rem; /* Equivalent to pt-3 */
            border-top: 1px solid #eee;
            font-weight: 600;
            text-align: right;
            color: #666;
            font-size: 1.1em;
        }

        /* Exam Calendar specific styles */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0; /* Removed margin-bottom to pull grid closer */
            background-color: #d0e0f0; /* Pastel blue */
            padding: 0.75rem;
            border-radius: 0.625rem 0.625rem 0 0; /* Rounded top corners only */
            font-weight: 600;
            color: #333;
        }
        .calendar-nav-btn {
            background-color: #a0d0b0;
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.3rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .calendar-nav-btn:hover {
            background-color: #80b090;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* Ensures 7 equal columns */
            gap: 0.25rem;
            text-align: center;
            padding: 0.75rem; /* Added padding to match header's horizontal padding */
            background-color: #f7f3f7; /* Match body background for seamless look */
            border-radius: 0 0 0.625rem 0.625rem; /* Rounded bottom corners only */
        }
        .calendar-day-header {
            font-weight: bold;
            padding: 0.5rem 0; /* Adjusted padding to vertical only */
            background-color: #f0e0f0; /* Lighter pastel pink */
            border-radius: 0.3rem;
        }
        .calendar-day {
            padding: 0.5rem 0; /* Adjusted padding to vertical only */
            background-color: #f7f3f7; /* Match body background */
            border-radius: 0.3rem;
            min-height: 50px; /* Ensure some height for content */
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-size: 0.9em; /* Default font size for day number */
            display: flex; /* Use flexbox for centering content */
            flex-direction: column; /* Stack day number and indicator vertically */
            justify-content: center; /* Center content vertically */
            align-items: center; /* Center content horizontally */
        }
        .calendar-day:hover {
            background-color: #e0d0e0;
        }
        .calendar-day.empty {
            background-color: #eee;
            cursor: default;
        }
        .calendar-day.has-exam {
            background-color: #ffc080; /* Pastel orange for exam days */
            font-weight: bold;
            color: #4a2a00;
            border: 1px solid #ffb060;
        }
        .exam-indicator {
            font-size: 0.6em; /* Smaller font for the count */
            color: #8b0000;
            margin-top: 0.2rem;
            line-height: 1; /* Compact line height */
        }
        .exam-details-modal-content {
            max-height: 80vh;
            overflow-y: auto;
        }

        /* New: Previa unmet styling */
        .subject-item.previa-unmet {
            opacity: 0.6; /* Dim the item */
            filter: grayscale(50%); /* Slightly desaturate */
            /* cursor: not-allowed; Removed to allow editing */
            background-color: #e9e9e9; /* Lighter grey background */
        }
        .subject-item.previa-unmet .subject-checkbox {
            cursor: not-allowed;
        }
        /* Removed pointer-events: none from these to allow editing */
        /* .subject-item.previa-unmet .subject-credits,
        .subject-item.previa-unmet .subject-type,
        .subject-item.previa-unmet .delivery-type {
            pointer-events: none;
            color: #a0a0a0;
        } */
        .subject-item.previa-unmet .subject-name {
            color: #a0a0a0; /* Still grey out text for visual consistency */
        }
        .subject-item.previa-unmet .subject-icons .grade-status-trigger,
        .subject-item.previa-unmet .subject-icons .subject-info-trigger {
            color: #a0a0a0; /* Still grey out text for visual consistency */
            background-color: rgba(233, 233, 233, 0.5); /* Adjust trigger background */
        }


        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 1.5rem;
            flex-direction: column;
            gap: 1rem;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification Banner Styles */
        .notification-banner {
            background-color: #4a4a4a; /* Dark grey, similar to image */
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 0.625rem;
            margin-top: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .notification-banner:hover {
            background-color: #6a6a6a;
        }
        .notification-count {
            background-color: #ff6347; /* Tomato red */
            color: white;
            border-radius: 50%;
            padding: 0.2rem 0.6rem;
            font-size: 0.8em;
            font-weight: bold;
        }
        .notification-message {
            flex-grow: 1;
            text-align: center;
        }

        /* Upcoming Events Modal Styles */
        .upcoming-event-item {
            background-color: #f0f0f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }
        .upcoming-event-item .close-btn {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2em;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .upcoming-event-item .close-btn:hover {
            color: #333;
        }

        /* New: Sub-semester label styling */
        /* Adjusted to be fixed below the semester title */
        .sub-semester-label {
            font-size: 0.8em;
            color: #999;
            margin-top: 0.25rem; /* Small space below main title */
            margin-bottom: 0.5rem; /* Space below it */
            text-align: left; /* Align with semester title */
            width: 100%; /* Ensure it takes full width for consistent alignment */
        }

        /* Total Weekly Hours styling */
        .total-weekly-hours {
            margin-top: 1.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid #eee;
            font-weight: 600;
            text-align: right;
            color: #666;
            font-size: 1.1em;
        }


        /* Responsive adjustments using Tailwind's approach for media queries */
        @media (max-width: 768px) {
            .year-selection-buttons {
                flex-direction: column; /* Stack buttons vertically */
                align-items: center;
            }
            .year-button, .calendar-main-button { /* Apply to both types of buttons */
                width: 80%; /* Make buttons wider on small screens */
            }
            .subject-item {
                /* flex-wrap: wrap; Already set above */
                padding-right: 0.75rem; /* Reset padding for smaller screens if it wraps */
            }
            .subject-checkbox {
                margin-bottom: 0.5rem; /* Add space below checkbox on wrap */
            }
            .subject-details {
                flex-basis: 100%; /* Make details take full width on wrap */
                margin-bottom: 0.5rem;
            }
            .subject-tags {
                flex-basis: 100%; /* Make tags take full width on wrap */
                margin-bottom: 0.5rem;
            }
            /* Icons container remains absolutely positioned */
            .subject-icons {
                position: absolute;
                top: 0.5rem;
                right: 0.5rem;
            }

            .schedule-table th, .schedule-table td {
                padding: 0.375rem; /* Smaller padding */
                font-size: 0.8em; /* Smaller font size */
            }
            .schedule-entry {
                font-size: 0.75em; /* Even smaller font for entries */
            }

            /* Calendar specific adjustments for smaller screens */
            .calendar-day {
                padding: 0.25rem 0; /* Reduce vertical padding for smaller screens */
                min-height: 40px; /* Smaller min-height */
                font-size: 0.8em; /* Smaller font for day number */
            }
            .exam-indicator {
                font-size: 0.55em; /* Even smaller font for exam indicator */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- Settings icon moved to top-left corner -->
            <div class="settings-icon" id="openSettingsModalBtn" aria-label="Abrir Configuraci√≥n" title="Configuraci√≥n">‚öôÔ∏è</div>
            <!-- New: Share icon moved to top-right corner -->
            <div class="share-icon" id="openShareScheduleModalBtn" aria-label="Compartir Horario" title="Compartir Horario">üîó</div>

            <h1 id="careerTitleDisplay" class="text-4xl font-bold text-gray-800 mb-2">INSERTAR TITULO</h1>
            <p class="text-lg text-gray-600">Tu progreso acad√©mico</p>

            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-2">Cr√©ditos Totales de la Carrera (Disponibles)</h3>
                <p id="totalAvailableCredits" class="text-2xl font-bold text-gray-700 mb-4">0</p>
            </div>

            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-2">Cr√©ditos Totales (Completados)</h3>
                <div class="progress-bar-container">
                    <div id="totalCreditsProgressBar" class="progress-bar" style="width: 0%;">0/0</div>
                </div>
                <p class="text-sm text-gray-500 mt-1">Cr√©ditos obtenidos de <span id="totalCareerCreditsDisplay">0</span> totales para la carrera.</p>
            </div>

            <div class="mt-4">
                <h3 class="text-xl font-semibold mb-2">T√≠tulo Intermedio (<span id="intermediateTitleCreditsDisplay">0</span> Cr√©ditos)</h3>
                <div class="progress-bar-container">
                    <div id="intermediateTitleProgressBar" class="progress-bar" style="width: 0%;">0/0</div>
                </div>
                <p class="text-sm text-gray-500 mt-1">Cr√©ditos para el t√≠tulo intermedio.</p>
            </div>

            <!-- Calendar Main Button moved back inside the header and centered -->
            <button id="calendarMainButton" class="calendar-main-button mx-auto mt-4" aria-label="Ver Calendario Lectivo">
                Calendario Lectivo
            </button>

            <!-- New: Notification Banner -->
            <div id="notificationBanner" class="notification-banner mx-auto mt-4" role="status" aria-live="polite">
                <span id="notificationMessage" class="notification-message">No hay notificaciones pr√≥ximas.</span>
                <span id="notificationCount" class="notification-count">0</span>
            </div>
        </div>

        <!-- New: Academic Calendar Section (Hidden by default, shown when "Calendario Lectivo" button is clicked) -->
        <!-- Placed directly after the header, and centered -->
        <div id="calendarWrapper" class="semester-section mb-8 hidden mx-auto">
            <h2 class="text-2xl font-bold mb-4 text-gray-800">Calendario Lectivo</h2>
            <div class="flex justify-center gap-4 mb-4">
                <label for="calendarYearSelect" class="sr-only">Seleccionar A√±o del Calendario</label>
                <select id="calendarYearSelect" class="shadow border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" aria-label="Seleccionar A√±o del Calendario"></select>
            </div>
            <div class="calendar-header">
                <button id="prevMonthBtn" class="calendar-nav-btn" aria-label="Mes Anterior">‚Üê</button>
                <span id="currentMonthYear" aria-live="polite"></span>
                <button id="nextMonthBtn" class="calendar-nav-btn" aria-label="Mes Siguiente">‚Üí</button>
            </div>
            <div id="calendarGrid" class="calendar-grid" role="grid" aria-labelledby="currentMonthYear">
                <!-- Calendar days will be populated by JavaScript -->
            </div>
        </div>

        <!-- Year Management Buttons (moved to be above the year selection buttons) -->
        <div class="flex justify-center gap-4 mb-8">
            <button id="addYearBtn" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Agregar Nuevo A√±o Acad√©mico">
                Agregar A√±o
            </button>
            <button id="removeYearBtn" class="bg-red-600 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Eliminar A√±o Acad√©mico Actual">
                Eliminar A√±o Actual
            </button>
        </div>

        <!-- Year Selection Buttons (now placed where calendar was, to be populated by JS) -->
        <div class="year-selection-buttons" id="yearSelectionButtons" role="tablist" aria-label="A√±os Acad√©micos">
            <!-- Buttons will be populated by JavaScript -->
        </div>

        <!-- Dynamic Content Area for Semesters and their Schedules -->
        <!-- Added overflow-x-auto for horizontal scrolling on small screens -->
        <div id="semesterContentArea" class="overflow-x-auto">
            <!-- Semesters and schedules will be populated by JavaScript -->
        </div>
    </div>

    <!-- Subject Editing/Adding Modal -->
    <div id="editSubjectModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800">Editar Materia</h2>
            <input type="hidden" id="editSubjectId">
            <input type="hidden" id="editSubjectYear">
            <input type="hidden" id="editSubjectSemester">

            <div class="mb-4">
                <label for="editSubjectName" class="block text-gray-700 text-sm font-bold mb-2">Nombre de la Materia:</label>
                <input type="text" id="editSubjectName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>

            <div class="flex flex-wrap -mx-2 mb-4">
                <div class="w-full md:w-1/2 px-2 mb-4 md:mb-0">
                    <label for="editSubjectCredits" class="block text-gray-700 text-sm font-bold mb-2">Cr√©ditos:</label>
                    <input type="number" id="editSubjectCredits" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="1" required>
                </div>

                <div class="w-full md:w-1/2 px-2">
                    <label for="editSubjectType" class="block text-gray-700 text-sm font-bold mb-2">Tipo:</label>
                    <select id="editSubjectType" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="Obligatoria">Obligatoria</option>
                        <option value="Opcional">Opcional</option>
                        <option value="Electiva">Electiva</option>
                    </select>
                </div>
            </div>

            <div class="flex flex-wrap -mx-2 mb-4">
                <div class="w-full md:w-1/2 px-2 mb-4 md:mb-0">
                    <label for="editDeliveryType" class="block text-gray-700 text-sm font-bold mb-2">Modalidad:</label>
                    <select id="editDeliveryType" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="Presencial">Presencial</option>
                        <option value="A Distancia">A Distancia</option>
                        <option value="Hibrida">H√≠brida</option> <!-- New: Hibrida option -->
                    </select>
                </div>
                <!-- New: Schedule Code Input -->
                <div class="w-full md:w-1/2 px-2">
                    <label for="editScheduleCode" class="block text-gray-700 text-sm font-bold mb-2">C√≥digo Horario (1-10):</label>
                    <input type="number" id="editScheduleCode" min="1" max="10" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
            </div>

            <!-- New: Previa Filters and Selection -->
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">Materias Previas:</label>
                <div class="flex gap-2 mb-2">
                    <label for="filterPreviaYear" class="sr-only">Filtrar Previas por A√±o</label>
                    <select id="filterPreviaYear" class="shadow border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-1/2">
                        <option value="">Todos los A√±os</option>
                        <!-- Years populated by JS -->
                    </select>
                    <label for="filterPreviaSemester" class="sr-only">Filtrar Previas por Semestre</label>
                    <select id="filterPreviaSemester" class="shadow border rounded py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-1/2">
                        <option value="">Todos los Semestres</option>
                        <!-- Semesters populated by JS -->
                    </select>
                </div>
                <label for="editSubjectPrevias" class="sr-only">Seleccionar Materias Previas</label>
                <select id="editSubjectPrevias" multiple class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-32" aria-describedby="previa-help-text">
                    <option value="">Sin seleccionar</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
                <p id="previa-help-text" class="text-xs text-gray-500 mt-1">Ctrl/Cmd + Click para seleccionar m√∫ltiples.</p>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-gray-700">Horario de la Materia:</h3>
            <div id="editSubjectScheduleContainer" class="mb-4 space-y-2">
                <!-- Schedule slots will be dynamically added here -->
            </div>
            <button id="addScheduleSlotBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Agregar Horario">
                Agregar Horario
            </button>

            <div class="flex justify-end mt-6">
                <button id="saveSubjectBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Guardar Cambios">
                    Guardar Cambios
                </button>
                <button id="cancelSubjectBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Subjects Modal -->
    <div id="deleteSubjectsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="deleteModalTitle">
        <div class="bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="deleteModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Selecciona Materia a Eliminar</h2>
            <input type="hidden" id="deleteModalYear">
            <input type="hidden" id="deleteModalSemester">

            <div id="deleteSubjectList" class="mb-4 space-y-2">
                <!-- Subject names will be populated here, clickable for direct deletion -->
            </div>

            <div class="flex justify-end mt-6">
                <button id="cancelDeleteSubjectsBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cerrar">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="settingsModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Configuraci√≥n General</h2>

            <div class="mb-4">
                <label for="editCareerTitle" class="block text-gray-700 text-sm font-bold mb-2">T√≠tulo de la Carrera:</label>
                <input type="text" id="editCareerTitle" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>

            <div class="mb-4">
                <label for="editTotalCareerCredits" class="block text-gray-700 text-sm font-bold mb-2">Cr√©ditos Totales de la Carrera:</label>
                <input type="number" id="editTotalCareerCredits" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="1" required>
            </div>

            <div class="mb-4">
                <label for="editIntermediateTitleCredits" class="block text-gray-700 text-sm font-bold mb-2">Cr√©ditos para T√≠tulo Intermedio:</label>
                <input type="number" id="editIntermediateTitleCredits" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" min="0" required>
            </div>

            <div class="flex justify-end mt-6">
                <button id="saveSettingsBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Guardar Configuraci√≥n">
                    Guardar Configuraci√≥n
                </button>
                <button id="cancelSettingsBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirmation Modal -->
    <div id="customAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" role="alertdialog" aria-modal="true" aria-labelledby="alertModalTitle">
        <div class="bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/4">
            <h3 id="alertModalTitle" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="alertModalMessage" class="mb-6 text-gray-700"></p>
            <div class="flex justify-end gap-3">
                <button id="alertModalConfirmBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200 hidden" aria-label="Confirmar">
                    Confirmar
                </button>
                <button id="alertModalCloseBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cerrar">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Academic Details Modal (renamed from Exam Details Modal) -->
    <div id="academicDetailsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="academicDateDisplay">
        <div class="bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 exam-details-modal-content">
            <h2 class="text-2xl font-bold mb-4 text-gray-800"><span id="academicDateDisplay"></span></h2>
            <div id="eventsForSelectedDate" class="space-y-3">
                <!-- Event details will be populated here -->
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeAcademicDetailsModalBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cerrar Detalles de Eventos">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Grade and Exam Status Input Modal -->
    <div id="gradeStatusModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="gradeStatusModalTitle">
        <div class="bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="gradeStatusModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Notas y Estado de Examen</h2>
            <input type="hidden" id="gradeStatusSubjectId">

            <div class="mb-4">
                <label for="inputPartial1Grade" class="block text-gray-700 text-sm font-bold mb-2">Nota Primer Parcial:</label>
                <select id="inputPartial1Grade" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <!-- Options populated by JS -->
                </select>
            </div>
            <div class="mb-4">
                <label for="inputPartial1Date" class="block text-gray-700 text-sm font-bold mb-2">Fecha Primer Parcial:</label>
                <input type="date" id="inputPartial1Date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="inputPartial1Time" class="block text-gray-700 text-sm font-bold mb-2">Hora Primer Parcial:</label>
                <input type="time" id="inputPartial1Time" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>

            <div class="mb-4">
                <label for="inputPartial2Grade" class="block text-gray-700 text-sm font-bold mb-2">Nota Segundo Parcial:</label>
                <select id="inputPartial2Grade" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <!-- Options populated by JS -->
                </select>
            </div>
            <div class="mb-4">
                <label for="inputPartial2Date" class="block text-gray-700 text-sm font-bold mb-2">Fecha Segundo Parcial:</label>
                <input type="date" id="inputPartial2Date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="inputPartial2Time" class="block text-gray-700 text-sm font-bold mb-2">Hora Segundo Parcial:</label>
                <input type="time" id="inputPartial2Time" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>

            <div class="mb-4">
                <label for="inputFinalAverageGrade" class="block text-gray-700 text-sm font-bold mb-2">Promedio Final:</label>
                <select id="inputFinalAverageGrade" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div class="mb-4">
                <label for="inputExamStatus" class="block text-gray-700 text-sm font-bold mb-2">Estado de Examen:</label>
                <select id="inputExamStatus" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="No Definido">No Definido</option>
                    <option value="A Examen">A Examen</option>
                    <option value="Salvada">Salvada</option>
                </select>
            </div>

            <div id="examDateTimeContainer" class="mb-4 hidden">
                <div class="mb-4">
                    <label for="inputExamDate" class="block text-gray-700 text-sm font-bold mb-2">Fecha Examen Final:</label>
                    <input type="date" id="inputExamDate" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="mb-4">
                    <label for="inputExamTime" class="block text-gray-700 text-sm font-bold mb-2">Hora Examen Final:</label>
                    <input type="time" id="inputExamTime" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
            </div>

            <div class="mb-4">
                <label for="inputProfessor" class="block text-gray-700 text-sm font-bold mb-2">Profesor:</label>
                <input type="text" id="inputProfessor" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="inputZoomUrl" class="block text-gray-700 text-sm font-bold mb-2">URL Zoom:</label>
                <input type="url" id="inputZoomUrl" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="inputClassroom" class="block text-gray-700 text-sm font-bold mb-2">Aula:</label>
                <input type="text" id="inputClassroom" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>

            <div class="flex justify-end mt-6">
                <button id="saveGradeStatusBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Guardar Notas y Estado">
                    Guardar
                </button>
                <button id="cancelGradeStatusBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Subject Info Modal -->
    <div id="subjectInfoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="subjectInfoModalTitle">
        <div class="bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="subjectInfoModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Detalles de la Materia</h2>
            <div id="subjectInfoContent" class="space-y-3 text-gray-700">
                <!-- Subject info will be dynamically populated here -->
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeSubjectInfoModalBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cerrar Detalles de Materia">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Share Schedule Modal -->
    <div id="shareScheduleModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden" role="dialog" aria-modal="true" aria-labelledby="shareScheduleModalTitle">
        <div class="bg-white p-8 rounded-xl shadow-lg w-11/12 md:w-1/2 lg:w-1/3 modal-content">
            <h2 id="shareScheduleModalTitle" class="text-2xl font-bold mb-4 text-gray-800">Compartir Horario</h2>
            <p class="mb-4 text-gray-700">Selecciona el a√±o y semestre del horario semanal que deseas generar en PDF:</p>

            <div class="mb-4">
                <label for="shareYearSelect" class="block text-gray-700 text-sm font-bold mb-2">A√±o:</label>
                <select id="shareYearSelect" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" aria-label="Seleccionar A√±o para Compartir"></select>
            </div>

            <div class="mb-4">
                <label for="shareSemesterSelect" class="block text-gray-700 text-sm font-bold mb-2">Semestre:</label>
                <select id="shareSemesterSelect" class="shadow border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" aria-label="Seleccionar Semestre para Compartir"></select>
            </div>

            <div class="flex justify-end mt-6">
                <button id="generatePdfBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mr-2 shadow-md transition duration-200" aria-label="Generar PDF">
                    Generar PDF
                </button>
                <button id="cancelShareScheduleBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-200" aria-label="Cancelar">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay HTML -->
    <div id="loadingOverlay" class="loading-overlay hidden" role="status" aria-live="assertive">
        <div class="spinner"></div>
        <p>Generando PDF, por favor espera...</p>
    </div>


    <script>
        // Global data storage
        let subjectsData = JSON.parse(localStorage.getItem('subjectsData')) || [];
        let completedSubjects = new Set(JSON.parse(localStorage.getItem('completedSubjects')) || []);
        // Modified: Set initial career title and credits to 0/0
        let careerSettings = JSON.parse(localStorage.getItem('careerSettings')) || {
            careerTitle: 'INSERTAR TITULO',
            totalCareerCredits: 0,
            intermediateTitleCredits: 0,
            completedCredits: 0 // Initialize completedCredits
        };

        let currentActiveView = ''; // Stores the currently active year (e.g., "A√±o 1") or "Calendario Lectivo"
        let currentCalendarDate = new Date(); // For the academic calendar

        // Global Chart.js instances to manage their destruction on re-render
        window.semesterCharts = window.semesterCharts || {};

        // --- Utility Functions ---

        /**
         * Generates a unique ID for subjects.
         * @returns {string} Unique ID.
         */
        function generateUniqueId() {
            return `sub-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        }

        /**
         * Converts a year number to its display name (e.g., 1 -> "A√±o 1").
         * @param {number} yearNum - The year number.
         * @returns {string} The year display name.
         */
        function getYearName(yearNum) {
            return `A√±o ${yearNum}`;
        }

        /**
         * Converts a Roman numeral semester string to an integer.
         * @param {string} roman - The Roman numeral string (e.g., "I", "II").
         * @returns {number} The integer representation.
         */
        function romanSemesterToInt(roman) {
            const romanMap = { 'I': 1, 'II': 2, 'III': 3, 'IV': 4, 'V': 5, 'VI': 6, 'VII': 7, 'VIII': 8, 'IX': 9, 'X': 10, 'XI': 11, 'XII': 12, 'XIII': 13, 'XIV': 14, 'XV': 15, 'XVI': 16, 'XVII': 17, 'XVIII': 18, 'XIX': 19, 'XX': 20 };
            return romanMap[roman.toUpperCase()] || 0;
        }

        /**
         * Converts an integer to a Roman numeral semester string.
         * @param {number} int - The integer.
         * @returns {string} The Roman numeral string.
         */
        function intToRomanSemester(int) {
            const romanMap = { 1: 'I', 2: 'II', 3: 'III', 4: 'IV', 5: 'V', 6: 'VI', 7: 'VII', 8: 'VIII', 9: 'IX', 10: 'X', 11: 'XI', 12: 'XII', 13: 'XIII', 14: 'XIV', 15: 'XV', 16: 'XVI', 17: 'XVII', 18: 'XVIII', 19: 'XIX', 20: 'XX' };
            return romanMap[int] || '';
        }

        /**
         * Finds a subject and its parent semester data by subject ID.
         * @param {string} subjectId - The ID of the subject to find.
         * @returns {object|null} An object containing the semester data and the subject, or null if not found.
         */
        function findSubjectAndSemesterById(subjectId) {
            for (const semesterData of subjectsData) {
                const subject = semesterData.subjects.find(sub => sub.id === subjectId);
                if (subject) {
                    return { semester: semesterData, subject: subject };
                }
            }
            return null;
        }

        /**
         * Finds a subject by its ID.
         * @param {string} subjectId - The ID of the subject.
         * @returns {object|null} The subject object or null if not found.
         */
        function getSubjectById(subjectId) {
            for (const semesterData of subjectsData) {
                const subject = semesterData.subjects.find(sub => sub.id === subjectId);
                if (subject) {
                    return subject;
                }
            }
            return null;
        }

        /**
         * Generates options for conceptual grades based on the provided image.
         * @param {string} selectedValue - The currently selected value.
         * @returns {string} HTML string for select options.
         */
        function generateConceptualGradeOptions(selectedValue) {
            const grades = [
                'No Definido', // Added for initial state
                'MUY INSUFICIENTE',
                'INSUFICIENTE (I)',
                'SIN CONCEPTO (SC)',
                'ACEPTABLE (A)',
                'BUENO (B)',
                'MUY BUENO (MB)',
                'EXCELENTE (E)'
            ];
            let optionsHtml = '';
            grades.forEach(grade => {
                optionsHtml += `<option value="${grade}" ${selectedValue === grade ? 'selected' : ''}>${grade}</option>`;
            });
            return optionsHtml;
        }

        // --- Local Storage Functions ---

        /**
         * Saves the subjects data to local storage.
         */
        function saveSubjectsData() {
            localStorage.setItem('subjectsData', JSON.stringify(subjectsData));
        }

        /**
         * Saves the completed subjects set to local storage.
         */
        function saveCompletedSubjects() {
            localStorage.setItem('completedSubjects', JSON.stringify(Array.from(completedSubjects)));
        }

        /**
         * Saves career settings to local storage.
         */
        function saveCareerSettings() {
            localStorage.setItem('careerSettings', JSON.stringify(careerSettings));
            updateHeaderDisplay();
        }

        // --- UI Update Functions ---

        /**
         * Recalculates and updates the total completed credits and progress bars.
         */
        function recalculateCompletedCredits() {
            let totalCompletedCredits = 0;
            subjectsData.forEach(semesterData => {
                semesterData.subjects.forEach(subject => {
                    if (completedSubjects.has(subject.id)) {
                        totalCompletedCredits += subject.credits;
                    }
                });
            });
            careerSettings.completedCredits = totalCompletedCredits;
            saveCareerSettings(); // Save the updated completed credits
            updateProgressBars();
        }

        /**
         * Updates the progress bars for total career credits and intermediate title credits.
         */
        function updateProgressBars() {
            const totalCareerCredits = careerSettings.totalCareerCredits;
            const intermediateTitleCredits = careerSettings.intermediateTitleCredits;
            const completed = careerSettings.completedCredits || 0;

            // Total Career Progress Bar
            const totalProgressBar = document.getElementById('totalCreditsProgressBar');
            const totalPercentage = totalCareerCredits > 0 ? (completed / totalCareerCredits) * 100 : 0;
            totalProgressBar.style.width = `${totalPercentage}%`;
            totalProgressBar.textContent = `${completed}/${totalCareerCredits}`;

            // Intermediate Title Progress Bar
            const intermediateProgressBar = document.getElementById('intermediateTitleProgressBar');
            const intermediatePercentage = intermediateTitleCredits > 0 ? (completed / intermediateTitleCredits) * 100 : 0;
            intermediateProgressBar.style.width = `${intermediatePercentage}%`;
            intermediateProgressBar.textContent = `${completed}/${intermediateTitleCredits}`;

            // Update display for total career credits and intermediate title credits
            document.getElementById('totalCareerCreditsDisplay').textContent = totalCareerCredits;
            document.getElementById('intermediateTitleCreditsDisplay').textContent = intermediateTitleCredits;
        }

        /**
         * Calculates and displays the total available credits (credits from subjects not yet completed).
         */
        function calculateTotalAvailableCredits() {
            let totalAvailableCredits = 0;
            subjectsData.forEach(semesterData => {
                semesterData.subjects.forEach(subject => {
                    if (!completedSubjects.has(subject.id)) {
                        totalAvailableCredits += subject.credits;
                    }
                });
            });
            document.getElementById('totalAvailableCredits').textContent = totalAvailableCredits;
        }

        /**
         * Updates the career title displayed in the header.
         */
        function updateHeaderDisplay() {
            document.getElementById('careerTitleDisplay').textContent = careerSettings.careerTitle;
            updateProgressBars(); // Ensure progress bars update with new total credits
        }

        /**
         * Renders the year selection buttons based on the available years in subjectsData.
         */
        function renderYearSelectionButtons() {
            const yearSelectionButtons = document.getElementById('yearSelectionButtons');
            yearSelectionButtons.innerHTML = ''; // Clear existing buttons

            const uniqueYears = [...new Set(subjectsData.map(data => data.year))].sort((a, b) => {
                const getYearNumber = (yearName) => {
                    const match = yearName.match(/\d+/);
                    return match ? parseInt(match[0]) : Infinity;
                };
                return getYearNumber(a) - getYearNumber(b);
            });

            if (uniqueYears.length === 0) {
                document.getElementById('semesterContentArea').innerHTML = '<p class="text-center text-gray-500 mt-10">No hay a√±os acad√©micos para mostrar. Agrega un nuevo a√±o para empezar.</p>';
                // If no years, and calendar is not active, set currentActiveView to empty
                if (currentActiveView !== 'Calendario Lectivo') {
                    currentActiveView = '';
                }
                return;
            }

            uniqueYears.forEach(year => {
                const button = document.createElement('button');
                // Only mark as active if currentActiveView matches this year AND it's not the calendar view
                button.className = `year-button ${currentActiveView === year && currentActiveView !== 'Calendario Lectivo' ? 'active' : ''}`;
                button.setAttribute('role', 'tab');
                button.setAttribute('aria-selected', currentActiveView === year && currentActiveView !== 'Calendario Lectivo' ? 'true' : 'false');
                button.setAttribute('aria-controls', `year-content-${year.replace(/\s/g, '-')}`); // For accessibility

                // Check if all subjects in this year are completed
                const yearSubjects = subjectsData.filter(s => s.year === year).flatMap(s => s.subjects);
                const allSubjectsInYearCompleted = yearSubjects.length > 0 && yearSubjects.every(subject => completedSubjects.has(subject.id));

                if (allSubjectsInYearCompleted) {
                    button.classList.add('year-completed');
                } else {
                    button.classList.add('year-incomplete');
                }

                button.textContent = year;
                button.onclick = () => showContent(year);
                yearSelectionButtons.appendChild(button);
            });

            // If there's no active view, or the active view was removed, or if calendar is not active, set the first year as active
            if (!currentActiveView || (!uniqueYears.includes(currentActiveView) && currentActiveView !== 'Calendario Lectivo')) {
                if (uniqueYears.length > 0) {
                    showContent(uniqueYears[0]);
                } else {
                    // This case is already handled by the `if (uniqueYears.length === 0)` block above.
                    // But if somehow `currentActiveView` is still set and there are no years, reset it.
                    currentActiveView = '';
                }
            }
        }

        /**
         * Renders the content for a specific academic year (semesters and subjects).
         * @param {string} yearToShow - The name of the year to display (e.g., "A√±o 1").
         */
        function showContent(yearToShow) {
            currentActiveView = yearToShow; // Set the active view
            document.getElementById('calendarWrapper').classList.add('hidden'); // Hide calendar
            document.getElementById('calendarMainButton').classList.remove('active'); // Deactivate calendar button

            const semesterContentArea = document.getElementById('semesterContentArea');
            semesterContentArea.classList.remove('hidden'); // Ensure semester content area is visible
            semesterContentArea.innerHTML = ''; // Clear previous content

            // Destroy existing Chart.js instances before re-rendering
            for (const chartId in window.semesterCharts) {
                if (window.semesterCharts.hasOwnProperty(chartId)) {
                    window.semesterCharts[chartId].destroy();
                }
            }
            window.semesterCharts = {}; // Reset the global chart instances object

            const semestersInYear = subjectsData.filter(data => data.year === yearToShow)
                                                .sort((a, b) => romanSemesterToInt(a.semester) - romanSemesterToInt(b.semester));

            semestersInYear.forEach((semesterData, index) => {
                const semesterSection = document.createElement('div');
                semesterSection.id = `semester-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`;
                semesterSection.className = 'semester-section mb-8';
                semesterSection.setAttribute('role', 'tabpanel');
                semesterSection.setAttribute('aria-labelledby', `year-content-${semesterData.year.replace(/\s/g, '-')}`);


                // Determine if it's the first or second semester of the year
                // This logic assumes semesters are added in pairs (I, II), (III, IV) etc.
                const semesterIndexInYear = semestersInYear.indexOf(semesterData);
                const semesterOrdinal = (semesterIndexInYear % 2 === 0) ? 'Primer' : 'Segundo';

                semesterSection.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-bold text-gray-800 flex-shrink-0 whitespace-nowrap mr-2">${semesterData.semester} Semestre</h2>
                        <div class="flex gap-2">
                            <button class="add-subject-btn bg-purple-500 hover:bg-purple-700 text-white text-sm py-1 px-3 rounded-md shadow-md transition duration-200"
                                data-year="${semesterData.year}" data-semester="${semesterData.semester}" aria-label="Agregar Materia al ${semesterData.semester} Semestre">
                                + Materia
                            </button>
                            <button class="delete-subjects-btn bg-red-500 hover:bg-red-800 text-white text-sm py-1 px-3 rounded-md shadow-md transition duration-200"
                                data-year="${semesterData.year}" data-semester="${semesterData.semester}" aria-label="Eliminar Materias del ${semesterData.semester} Semestre">
                                Eliminar Materias
                            </button>
                        </div>
                    </div>
                    <p class="sub-semester-label text-gray-500 mb-4">${semesterOrdinal} Semestre del ${semesterData.year}</p>
                    <div id="subjectList-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}" class="mb-6">
                        <!-- Subjects will be populated here -->
                    </div>
                    <div class="semester-credits-total">
                        Total Cr√©ditos Semestre: <span id="semesterCredits-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}">0</span>
                    </div>

                    <!-- New: Weekly Load Donut Chart -->
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Carga Horaria Semanal por Tipo</h3>
                        <div class="relative h-64 w-full">
                            <canvas id="typeChart-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}" aria-label="Gr√°fico de Carga Horaria Semanal por Tipo"></canvas>
                        </div>
                    </div>

                    <!-- New: Daily Load Boxes -->
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold mb-3 text-gray-700">Carga Horaria Diaria</h3>
                        <div id="dailyLoadContainer-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}" class="flex flex-wrap justify-center gap-4">
                            <!-- Daily load boxes will be rendered here by JS -->
                        </div>
                    </div>

                    <!-- New: Total Weekly Hours for the Semester -->
                    <div class="total-weekly-hours">
                        Total Horas Semanales del Semestre: <span id="totalWeeklyHours-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}">0.0h</span>
                    </div>

                    <h3 class="text-xl font-semibold mt-8 mb-3 text-gray-700">Horario del Semestre:</h3>
                    <div class="overflow-x-auto">
                        <table id="scheduleTable-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}" class="schedule-table">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Lunes</th>
                                    <th>Martes</th>
                                    <th>Mi√©rcoles</th>
                                    <th>Jueves</th>
                                    <th>Viernes</th>
                                    <th>S√°bado</th>
                                    <th>Domingo</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Schedule rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                `;
                semesterContentArea.appendChild(semesterSection);

                // Attach event listeners for add/delete buttons here, after appending
                const addButton = semesterSection.querySelector('.add-subject-btn');
                if (addButton) {
                    addButton.onclick = (event) => {
                        const year = event.target.dataset.year;
                        const semester = event.target.dataset.semester;
                        openAddSubjectModal(year, semester);
                    };
                }

                const deleteButton = semesterSection.querySelector('.delete-subjects-btn');
                if (deleteButton) {
                    deleteButton.onclick = (event) => {
                        const year = event.target.dataset.year;
                        const semester = event.target.dataset.semester;
                        openDeleteSubjectsModal(year, semester);
                    };
                }

                // Populate subjects and schedule table
                populateSubjectList(semesterData);
                populateScheduleTable(semesterData);

                // Calculate and render charts/daily load after elements are in DOM
                const typeHours = getSemesterTypeHours(semesterData.subjects);
                renderDonutChart(`typeChart-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`, typeHours);

                const dailyHours = getSemesterDailyHours(semesterData.subjects);
                renderDailyLoadBoxes(`dailyLoadContainer-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`, dailyHours);

                // Calculate and display total weekly hours for the semester
                const totalWeeklyHours = calculateSemesterTotalWeeklyHours(semesterData.subjects);
                document.getElementById(`totalWeeklyHours-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`).textContent = `${totalWeeklyHours.toFixed(1)}h`;
            });

            // Update active state for year buttons
            document.querySelectorAll('.year-button').forEach(btn => {
                if (btn.textContent === yearToShow) {
                    btn.classList.add('active');
                    btn.setAttribute('aria-selected', 'true');
                } else {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                }
            });
        }

        /**
         * Populates the subject list for a given semester.
         * @param {object} semesterData - The data for the semester.
         */
        function populateSubjectList(semesterData) {
            const subjectListDiv = document.getElementById(`subjectList-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`);
            subjectListDiv.innerHTML = '';
            let semesterTotalCredits = 0;

            const allCompletedSubjectIds = new Set(Array.from(completedSubjects));

            if (semesterData.subjects.length === 0) {
                subjectListDiv.innerHTML = '<p class="text-center text-gray-500 mt-4">No hay materias en este semestre. Haz clic en "+ Materia" para agregar una.</p>';
            }

            semesterData.subjects.forEach(subject => {
                const isCompleted = allCompletedSubjectIds.has(subject.id);

                // Check for unmet previas
                const hasUnmetPrevia = subject.previas.some(previaId => !allCompletedSubjectIds.has(previaId));

                const subjectItem = document.createElement('div');
                subjectItem.className = `subject-item ${isCompleted ? 'bg-green-50' : 'bg-gray-50'} ${hasUnmetPrevia ? 'previa-unmet' : ''} type-${subject.type}`;
                subjectItem.setAttribute('aria-labelledby', `subject-name-${subject.id}`);

                subjectItem.innerHTML = `
                    <input type="checkbox" class="subject-checkbox" id="subject-checkbox-${subject.id}" data-subject-id="${subject.id}" ${isCompleted ? 'checked' : ''} ${hasUnmetPrevia ? 'disabled' : ''} aria-label="Marcar ${subject.name} como completada">
                    <div class="subject-details">
                        <span class="subject-name ${isCompleted ? 'completed' : ''}" id="subject-name-${subject.id}" data-subject-id="${subject.id}" role="button" tabindex="0">${subject.name}</span>
                        <div class="subject-credits-and-code">
                            <span class="subject-credits">${subject.credits} cr√©ditos</span>
                            ${subject.scheduleCode !== null ? `<span class="subject-schedule-code bg-blue-200">Cod: ${subject.scheduleCode}</span>` : ''}
                        </div>
                    </div>
                    <div class="subject-tags">
                        <span class="subject-type type-${subject.type}">${subject.type}</span>
                        <span class="delivery-type delivery-type-${subject.deliveryType.replace(/\s/g, '')}">${subject.deliveryType}</span>
                    </div>
                    <div class="subject-icons">
                        <span class="grade-status-trigger" data-subject-id="${subject.id}" title="Notas y Estado" role="button" tabindex="0" aria-label="Ver/Editar Notas y Estado de ${subject.name}">üìù</span>
                        <span class="subject-info-trigger" data-subject-id="${subject.id}" title="Ver Detalles" role="button" tabindex="0" aria-label="Ver Detalles de ${subject.name}">‚ÑπÔ∏è</span>
                    </div>
                `;
                subjectListDiv.appendChild(subjectItem);

                if (isCompleted) {
                    semesterTotalCredits += subject.credits;
                }
            });

            document.getElementById(`semesterCredits-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`).textContent = semesterTotalCredits;

            // Add event listeners for checkboxes
            subjectListDiv.querySelectorAll('.subject-checkbox').forEach(checkbox => {
                checkbox.onchange = (event) => {
                    const subjectId = event.target.dataset.subjectId;
                    if (event.target.checked) {
                        completedSubjects.add(subjectId);
                    } else {
                        completedSubjects.delete(subjectId);
                    }
                    saveCompletedSubjects();
                    recalculateCompletedCredits();
                    calculateTotalAvailableCredits();
                    showContent(currentActiveView); // Re-render to update UI (e.g., previas)
                    renderYearSelectionButtons(); // Update year button status
                };
            });

            // Add event listeners for subject name (to open edit modal)
            subjectListDiv.querySelectorAll('.subject-name').forEach(nameSpan => {
                nameSpan.onclick = (event) => {
                    const subjectId = event.target.dataset.subjectId;
                    // Removed the check for previa-unmet here to allow editing
                    openEditSubjectModal(subjectId);
                };
                nameSpan.onkeydown = (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        nameSpan.click();
                    }
                };
            });

            // Add event listeners for grade status trigger
            subjectListDiv.querySelectorAll('.grade-status-trigger').forEach(trigger => {
                trigger.onclick = (event) => {
                    const subjectId = event.target.dataset.subjectId;
                    openGradeStatusModal(subjectId);
                };
                trigger.onkeydown = (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        trigger.click();
                    }
                };
            });

            // Add event listeners for subject info trigger
            subjectListDiv.querySelectorAll('.subject-info-trigger').forEach(trigger => {
                trigger.onclick = (event) => {
                    const subjectId = event.target.dataset.subjectId;
                    openSubjectInfoModal(subjectId);
                };
                trigger.onkeydown = (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        trigger.click();
                    }
                };
            });
        }

        /**
         * Checks for and marks overlapping schedule entries within a semester.
         * This function modifies the subject objects directly to add an 'overlap' property.
         * @param {object} semesterData - The data for the semester.
         */
        function updateSemesterOverlaps(semesterData) {
            // Reset overlap status for all subjects in this semester
            semesterData.subjects.forEach(subject => {
                subject.schedule.forEach(slot => {
                    slot.overlap = false; // Reset overlap flag
                });
                // Also reset overlap for the subject itself, if it had a global overlap flag
                // (though the current structure doesn't seem to have a subject-level overlap flag, only slot-level)
            });

            const subjects = semesterData.subjects;
            for (let i = 0; i < subjects.length; i++) {
                for (let j = i + 1; j < subjects.length; j++) {
                    const subject1 = subjects[i];
                    const subject2 = subjects[j];

                    subject1.schedule.forEach(slot1 => {
                        subject2.schedule.forEach(slot2 => {
                            if (slot1.day === slot2.day) {
                                // Convert times to Date objects for easy comparison
                                const start1 = new Date(`2000/01/01T${slot1.start}`);
                                const end1 = new Date(`2000/01/01T${slot1.end}`);
                                const start2 = new Date(`2000/01/01T${slot2.start}`);
                                const end2 = new Date(`2000/01/01T${slot2.end}`);

                                // Check for overlap: (start1 < end2) && (end1 > start2)
                                if (start1 < end2 && end1 > start2) {
                                    slot1.overlap = true;
                                    slot2.overlap = true;
                                }
                            }
                        });
                    });
                }
            }
        }

        /**
         * Populates the schedule table for a given semester.
         * @param {object} semesterData - The data for the semester.
         * @param {string} tableId - The ID of the table to populate.
         */
        function populateScheduleTable(semesterData, tableId = null) {
            const targetTableId = tableId || `scheduleTable-${semesterData.year}-${semesterData.semester.replace(/\s/g, '-')}`;
            const scheduleTableBody = document.getElementById(targetTableId)?.querySelector('tbody');

            if (!scheduleTableBody) {
                console.warn(`Table body with ID ${targetTableId} not found for schedule population.`);
                return;
            }
            scheduleTableBody.innerHTML = '';

            const timeSlots = {}; // { "HH:MM-HH:MM": { "Lunes": [], ... } }

            // Define fixed time intervals from 8:00 to 23:00
            const fixedIntervals = [];
            for (let h = 8; h < 23; h++) {
                const start = `${String(h).padStart(2, '0')}:00`;
                const end = `${String(h + 1).padStart(2, '0')}:00`;
                fixedIntervals.push({ start, end });
            }

            // Initialize timeSlots with fixed intervals
            fixedIntervals.forEach(interval => {
                const slotKey = `${interval.start}-${interval.end}`;
                timeSlots[slotKey] = {
                    display: `${interval.start} - ${interval.end}`,
                    days: { 'Lunes': [], 'Martes': [], 'Mi√©rcoles': [], 'Jueves': [], 'Viernes': [], 'S√°bado': [], 'Domingo': [] }
                };
            });

            // Populate timeSlots with subjects
            semesterData.subjects.forEach(subject => {
                subject.schedule.forEach(slot => {
                    const subjectStartTime = slot.start;
                    const subjectEndTime = slot.end;
                    const subjectDay = slot.day;

                    // Find all fixed intervals that this subject's slot covers
                    fixedIntervals.forEach(interval => {
                        const intervalStart = interval.start;
                        const intervalEnd = interval.end;

                        // Check for overlap between subject slot and fixed interval
                        // (start1 < end2) && (end1 > start2)
                        if (subjectStartTime < intervalEnd && subjectEndTime > intervalStart) {
                            const slotKey = `${intervalStart}-${intervalEnd}`;
                            if (timeSlots[slotKey] && timeSlots[slotKey].days[subjectDay]) {
                                timeSlots[slotKey].days[subjectDay].push({
                                    id: subject.id,
                                    name: subject.name,
                                    type: subject.type,
                                    scheduleCode: subject.scheduleCode,
                                    start: subjectStartTime,
                                    end: subjectEndTime
                                });
                            }
                        }
                    });
                });
            });

            // Check for overlaps and mark them
            updateSemesterOverlaps(semesterData);

            // Render table rows
            for (const slotKey in timeSlots) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="schedule-time">${timeSlots[slotKey].display}</td>`;

                const daysOfWeek = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
                daysOfWeek.forEach(day => {
                    const cell = document.createElement('td');
                    const entries = timeSlots[slotKey].days[day];
                    const uniqueEntries = Array.from(new Set(entries.map(e => JSON.stringify(e))))
                                                .map(e => JSON.parse(e)); // Remove duplicates

                    uniqueEntries.forEach(entry => {
                        const entryDiv = document.createElement('div');
                        // Find the original subject object to get the 'overlap' status from its schedule slot
                        const originalSubject = semesterData.subjects.find(s => s.id === entry.id);
                        const originalSlot = originalSubject ? originalSubject.schedule.find(s => s.day === day && s.start === entry.start && s.end === entry.end) : null;
                        const isOverlap = originalSlot ? originalSlot.overlap : false;

                        entryDiv.className = `schedule-entry type-${entry.type} ${isOverlap ? 'overlap' : ''}`;
                        entryDiv.textContent = entry.name;
                        if (entry.scheduleCode !== null) {
                            entryDiv.textContent += ` (Cod: ${entry.scheduleCode})`;
                        }
                        cell.appendChild(entryDiv);
                    });
                    row.appendChild(cell);
                });
                scheduleTableBody.appendChild(row);
            }
        }

        /**
         * Renders the notification banner with upcoming events.
         */
        function renderNotificationBanner() {
            const notificationBanner = document.getElementById('notificationBanner');
            const notificationMessage = document.getElementById('notificationMessage');
            const notificationCount = document.getElementById('notificationCount');

            const upcomingEvents = getAcademicEvents(true); // Get all future events

            if (upcomingEvents.length > 0) {
                notificationBanner.classList.remove('hidden');
                notificationCount.textContent = upcomingEvents.length;
                notificationMessage.textContent = `Tienes ${upcomingEvents.length} eventos pr√≥ximos.`; // Removed "Haz click para ver"
                notificationBanner.onclick = () => openUpcomingEventsModal(upcomingEvents);
            } else {
                notificationBanner.classList.add('hidden');
                notificationCount.textContent = '0';
                notificationMessage.textContent = 'No hay notificaciones pr√≥ximas.';
                notificationBanner.onclick = null; // Remove click handler
            }
        }

        /**
         * Opens a modal to display all upcoming events.
         * @param {object[]} events - An array of upcoming event objects.
         */
        function openUpcomingEventsModal(events) {
            const modal = document.getElementById('academicDetailsModal'); // Reuse academic details modal
            document.getElementById('academicDateDisplay').textContent = 'Eventos Pr√≥ximos'; // Set title for all upcoming events
            const eventsForSelectedDate = document.getElementById('eventsForSelectedDate');
            eventsForSelectedDate.innerHTML = '';

            if (events && events.length > 0) {
                events.forEach(event => {
                    const eventDetailDiv = document.createElement('div');
                    eventDetailDiv.className = 'upcoming-event-item';
                    eventDetailDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${event.eventType}: ${event.name}</p>
                            <p class="text-sm text-gray-600">${new Date(event.eventDate + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })} ${event.eventTime ? `(${event.eventTime})` : ''}</p>
                            ${event.professor ? `<p class="text-sm text-gray-600">Profesor: ${event.professor}</p>` : ''}
                            ${event.zoomUrl ? `<p class="text-sm text-gray-600">Zoom: <a href="${event.zoomUrl}" target="_blank" class="text-blue-600 hover:underline" aria-label="Abrir enlace de Zoom para ${event.name}">Enlace</a></p>` : ''}
                            ${event.classroom ? `<p class="text-sm text-gray-600">Aula: ${event.classroom}</p>` : ''}
                        </div>
                        <button class="close-btn" data-event-id="${event.id}" aria-label="Remover notificaci√≥n de ${event.name}">‚úï</button>
                    `;
                    eventsForSelectedDate.appendChild(eventDetailDiv);

                    // Add event listener to remove button (visual dismissal only)
                    eventDetailDiv.querySelector('.close-btn').onclick = () => {
                        eventDetailDiv.remove();
                        // If all events are dismissed, hide the modal and update banner
                        if (eventsForSelectedDate.children.length === 0) {
                            closeAcademicDetailsModal();
                            renderNotificationBanner(); // Re-render banner to show 0 if all dismissed
                        }
                    };
                });
            } else {
                eventsForSelectedDate.innerHTML = '<p class="text-gray-500">No hay eventos pr√≥ximos.</p>';
            }
            modal.classList.remove('hidden');
        }

        /**
         * Closes the academic details modal.
         */
        function closeAcademicDetailsModal() {
            document.getElementById('academicDetailsModal').classList.add('hidden');
        }


        // --- Year Management Functions ---

        /**
         * Adds a new academic year with two semesters.
         */
        function addYear() {
            const existingYearsCount = [...new Set(subjectsData.map(data => data.year))].length;
            const newYearNumber = existingYearsCount + 1;
            const newYearName = getYearName(newYearNumber);

            // Determine the next available semester number
            let nextSemesterNumber = 1;
            if (subjectsData.length > 0) {
                const allSemesterNumbers = subjectsData.map(data => romanSemesterToInt(data.semester));
                const maxSemesterInt = Math.max(...allSemesterNumbers);
                nextSemesterNumber = maxSemesterInt + 1;
            }

            const newSemester1Name = intToRomanSemester(nextSemesterNumber);
            const newSemester2Name = intToRomanSemester(nextSemesterNumber + 1);

            if (!newSemester1Name || !newSemester2Name) {
                showCustomAlert('Error', 'No se pueden agregar m√°s semestres. L√≠mite de semestres alcanzado (XX).');
                return;
            }

            const newYearSemesters = [
                { year: newYearName, semester: newSemester1Name, subjects: [] },
                { year: newYearName, semester: newSemester2Name, subjects: [] }
            ];

            subjectsData.push(...newYearSemesters);
            saveSubjectsData();
            renderYearSelectionButtons();
            showContent(newYearName); // Show the newly added year
            calculateTotalAvailableCredits(); // Recalculate total available credits
            renderAcademicCalendar(); // Update academic calendar
            renderNotificationBanner(); // Update notifications
        }

        /**
         * Removes the currently active academic year and all its subjects.
         */
        function removeYear() {
            if (!currentActiveView || currentActiveView === 'Calendario Lectivo') {
                showCustomAlert('Error', 'Selecciona un a√±o para eliminar.');
                return;
            }

            showCustomConfirmation(
                'Confirmar Eliminaci√≥n',
                `¬øEst√°s seguro de que quieres eliminar el "${currentActiveView}" y todas sus materias? Esta acci√≥n es irreversible.`,
                () => {
                    const yearToRemove = currentActiveView;
                    const subjectsInRemovedYear = subjectsData.filter(s => s.year === yearToRemove)
                                                               .flatMap(s => s.subjects);

                    // Remove subjects from completedSubjects set
                    subjectsInRemovedYear.forEach(subject => {
                        completedSubjects.delete(subject.id);
                    });

                    // Remove the year's semesters from subjectsData
                    subjectsData = subjectsData.filter(data => data.year !== yearToRemove);

                    saveSubjectsData();
                    saveCompletedSubjects();
                    recalculateCompletedCredits();
                    updateProgressBars();
                    calculateTotalAvailableCredits();

                    // Determine the new active year
                    let newActiveView = '';
                    const uniqueYears = [...new Set(subjectsData.map(data => data.year))].sort((a, b) => {
                        const getYearNumber = (yearName) => {
                            const match = yearName.match(/\d+/);
                            return match ? parseInt(match[0]) : Infinity;
                        };
                        return getYearNumber(a) - getYearNumber(b);
                    });

                    if (uniqueYears.length > 0) {
                        // Try to activate the previous year, or the first available if none
                        const removedYearIndex = uniqueYears.indexOf(yearToRemove);
                        if (removedYearIndex > 0) {
                            newActiveView = uniqueYears[removedYearIndex - 1];
                        } else {
                            newActiveView = uniqueYears[0];
                        }
                    }

                    renderYearSelectionButtons();
                    if (newActiveView) {
                        showContent(newActiveView);
                    } else {
                        document.getElementById('semesterContentArea').innerHTML = '<p class="text-center text-gray-500 mt-10">No hay a√±os acad√©micos para mostrar. Agrega un nuevo a√±o para empezar.</p>';
                        currentActiveView = ''; // Reset active view if no years left
                    }
                    renderAcademicCalendar(); // Update academic calendar
                    renderNotificationBanner(); // Update notifications
                }
            );
        }


        // --- Modal Functions for Subject Editing/Adding ---

        /**
         * Populates the previa filter dropdowns (year and semester).
         * @param {string} currentSubjectId - The ID of the subject being edited (to exclude itself).
         * @param {string} selectedYearFilter - The currently selected year filter.
         * @param {string} selectedSemesterFilter - The currently selected semester filter.
         */
        function populatePreviaFilters(currentSubjectId, selectedYearFilter = '', selectedSemesterFilter = '') {
            const filterYearSelect = document.getElementById('filterPreviaYear');
            const filterSemesterSelect = document.getElementById('filterPreviaSemester');

            // Populate Year Filter
            filterYearSelect.innerHTML = '<option value="">Todos los A√±os</option>';
            const uniqueYears = [...new Set(subjectsData.map(data => data.year))].sort((a, b) => {
                const getYearNumber = (yearName) => {
                    const match = yearName.match(/\d+/);
                    return match ? parseInt(match[0]) : Infinity;
                };
                return getYearNumber(a) - getYearNumber(b);
            });
            uniqueYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === selectedYearFilter) {
                    option.selected = true;
                }
                filterYearSelect.appendChild(option);
            });

            // Populate Semester Filter based on selected year filter
            filterSemesterSelect.innerHTML = '<option value="">Todos los Semestres</option>';
            let semestersToFilter = [];
            if (selectedYearFilter) {
                semestersToFilter = [...new Set(subjectsData
                    .filter(data => data.year === selectedYearFilter)
                    .map(data => data.semester)
                )].sort((a, b) => romanSemesterToInt(a) - romanSemesterToInt(b)); // Sort by Roman numeral value
            } else {
                semestersToFilter = [...new Set(subjectsData.map(data => data.semester))].sort((a, b) => romanSemesterToInt(a) - romanSemesterToInt(b));
            }

            semestersToFilter.forEach(semester => {
                const option = document.createElement('option');
                option.value = semester;
                option.textContent = semester;
                if (semester === selectedSemesterFilter) {
                    option.selected = true;
                }
                filterSemesterSelect.appendChild(option);
            });
        }

        /**
         * Populates the previas dropdown with all available subjects, excluding the current one,
         * based on selected filters.
         * @param {string} currentSubjectId - The ID of the subject being edited (to exclude itself).
         * @param {string[]} selectedPrevias - An array of IDs of already selected previas.
         * @param {string} filterYear - The selected year filter.
         * @param {string} filterSemester - The selected semester filter.
         */
        function populatePreviasDropdown(currentSubjectId, selectedPrevias = [], filterYear = '', filterSemester = '') {
            const previasSelect = document.getElementById('editSubjectPrevias');
            previasSelect.innerHTML = ''; // Clear existing options

            // Add the "Sin seleccionar" option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Sin seleccionar';
            // Explicitly select this option if no previas are selected for the current subject
            if (selectedPrevias.length === 0) {
                defaultOption.selected = true;
            }
            previasSelect.appendChild(defaultOption);

            // Flatten all subjects into a single array and filter based on selected year and semester
            const filteredSubjects = subjectsData.flatMap(semester => semester.subjects)
                .filter(subject => {
                    if (subject.id === currentSubjectId) return false; // Exclude self
                    const subjectSemesterData = subjectsData.find(s => s.subjects.some(sub => sub.id === subject.id));
                    if (!subjectSemesterData) return false; // Should not happen

                    const matchesYear = filterYear === '' || subjectSemesterData.year === filterYear;
                    const matchesSemester = filterSemester === '' || subjectSemesterData.semester === filterSemester;
                    return matchesYear && matchesSemester;
                })
                .sort((a, b) => a.name.localeCompare(b.name)); // Sort alphabetically by name

            filteredSubjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name;
                if (selectedPrevias.includes(subject.id)) {
                    option.selected = true;
                    // If any subject is selected, ensure "Sin seleccionar" is NOT selected
                    defaultOption.selected = false;
                }
                previasSelect.appendChild(option);
            });
        }

        /**
         * Opens the subject editing modal and populates it with the subject's data.
         * @param {string} subjectId - The ID of the subject to edit.
         */
        function openEditSubjectModal(subjectId) {
            const result = findSubjectAndSemesterById(subjectId);
            if (!result) {
                showCustomAlert('Error', 'Materia no encontrada.');
                return;
            }
            const { semester, subject } = result;

            document.getElementById('modalTitle').textContent = 'Editar Materia';
            document.getElementById('editSubjectId').value = subject.id;
            document.getElementById('editSubjectYear').value = semester.year;
            document.getElementById('editSubjectSemester').value = semester.semester;
            document.getElementById('editSubjectName').value = subject.name;
            document.getElementById('editSubjectCredits').value = subject.credits;
            document.getElementById('editSubjectType').value = subject.type;
            document.getElementById('editDeliveryType').value = subject.deliveryType || 'Presencial'; // Set delivery type, default if missing
            document.getElementById('editScheduleCode').value = subject.scheduleCode !== null ? subject.scheduleCode : ''; // Populate schedule code

            // Initialize filters and populate previas
            populatePreviaFilters(subject.id); // Populate year/semester filters without initial selection
            populatePreviasDropdown(subject.id, subject.previas); // Populate previas with all options initially

            const scheduleContainer = document.getElementById('editSubjectScheduleContainer');
            scheduleContainer.innerHTML = ''; // Clear previous slots

            // Populate existing schedule slots
            subject.schedule.forEach((slot) => {
                addScheduleSlotToModal(slot);
            });

            document.getElementById('editSubjectModal').classList.remove('hidden');
        }

        /**
         * Opens the modal to add a new subject.
         * @param {string} year - The year for the new subject.
         * @param {string} semester - The semester for the new subject.
         */
        function openAddSubjectModal(year, semester) {
            document.getElementById('modalTitle').textContent = 'Agregar Nueva Materia';
            document.getElementById('editSubjectId').value = ''; // Clear ID for new subject
            document.getElementById('editSubjectYear').value = year;
            document.getElementById('editSubjectSemester').value = semester;
            document.getElementById('editSubjectName').value = '';
            document.getElementById('editSubjectCredits').value = '';
            document.getElementById('editSubjectType').value = 'Obligatoria'; // Default type
            document.getElementById('editDeliveryType').value = 'Presencial'; // Default delivery type
            document.getElementById('editScheduleCode').value = ''; // Clear schedule code for new subject

            // Initialize filters and populate previas for a new subject
            populatePreviaFilters(''); // Populate year/semester filters without initial selection
            populatePreviasDropdown(''); // Populate previas with all options initially

            const scheduleContainer = document.getElementById('editSubjectScheduleContainer');
            scheduleContainer.innerHTML = ''; // Clear previous slots
            addScheduleSlotToModal(); // Add one empty slot for new subject

            document.getElementById('editSubjectModal').classList.remove('hidden');
        }

        /**
         * Closes the subject editing/adding modal.
         */
        function closeEditSubjectModal() {
            document.getElementById('editSubjectModal').classList.add('hidden');
        }

        /**
         * Adds a new schedule slot input row to the modal.
         * @param {object} [slot={}] - Optional initial values for the slot (day, start, end).
         */
        function addScheduleSlotToModal(slot = { day: 'Lunes', start: '08:00', end: '09:00' }) {
            const scheduleContainer = document.getElementById('editSubjectScheduleContainer');
            const slotDiv = document.createElement('div');
            slotDiv.className = 'flex flex-wrap items-center gap-2 p-2 bg-gray-100 rounded-md shadow-sm';

            const daysOfWeek = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

            slotDiv.innerHTML = `
                <label class="sr-only" for="day-select-${Date.now()}">D√≠a</label>
                <select class="day-select shadow border rounded py-1 px-2 text-gray-700" id="day-select-${Date.now()}">
                    ${daysOfWeek.map(day => `<option value="${day}" ${slot.day === day ? 'selected' : ''}>${day}</option>`).join('')}
                </select>
                <label class="sr-only" for="start-time-input-${Date.now()}">Hora Inicio</label>
                <input type="time" class="start-time-input shadow border rounded py-1 px-2 text-gray-700" value="${slot.start}" id="start-time-input-${Date.now()}">
                <span>-</span>
                <label class="sr-only" for="end-time-input-${Date.now()}">Hora Fin</label>
                <input type="time" class="end-time-input shadow border rounded py-1 px-2 text-gray-700" value="${slot.end}" id="end-time-input-${Date.now()}">
                <button class="remove-slot-btn bg-red-400 hover:bg-red-600 text-white text-sm py-1 px-2 rounded-md transition duration-200" aria-label="Eliminar Horario">‚úï</button>
            `;
            scheduleContainer.appendChild(slotDiv);

            // Add event listener to the remove button for the newly created slot
            slotDiv.querySelector('.remove-slot-btn').onclick = (event) => {
                event.stopPropagation(); // Prevent modal from closing if this button is clicked
                slotDiv.remove();
            };
        }

        /**
         * Saves the changes made in the subject editing modal (for both new and existing subjects).
         */
        function saveSubjectChanges() {
            const subjectId = document.getElementById('editSubjectId').value;
            const year = document.getElementById('editSubjectYear').value;
            const semester = document.getElementById('editSubjectSemester').value;
            const newName = document.getElementById('editSubjectName').value.trim();
            const newCredits = parseInt(document.getElementById('editSubjectCredits').value);
            const newType = document.getElementById('editSubjectType').value;
            const newDeliveryType = document.getElementById('editDeliveryType').value;
            const newScheduleCodeInput = document.getElementById('editScheduleCode').value;
            const newScheduleCode = newScheduleCodeInput === '' ? null : parseInt(newScheduleCodeInput);


            // Get selected previas, filtering out the "Sin seleccionar" empty value
            const selectedPrevias = Array.from(document.getElementById('editSubjectPrevias').selectedOptions)
                                            .map(option => option.value)
                                            .filter(value => value !== '');

            // Basic validation
            if (!newName) {
                showCustomAlert('Error', 'El nombre de la materia no puede estar vac√≠o.');
                return;
            }
            if (isNaN(newCredits) || newCredits <= 0) {
                showCustomAlert('Error', 'Los cr√©ditos deben ser un n√∫mero positivo.');
                return;
            }
            if (newScheduleCode !== null && (isNaN(newScheduleCode) || newScheduleCode < 1 || newScheduleCode > 10)) {
                showCustomAlert('Error', 'El C√≥digo Horario debe ser un n√∫mero entre 1 y 10, o dejarse vac√≠o.');
                return;
            }

            const updatedSchedule = [];
            let hasInvalidTime = false;
            document.querySelectorAll('#editSubjectScheduleContainer > div').forEach(slotDiv => {
                const day = slotDiv.querySelector('.day-select').value;
                const start = slotDiv.querySelector('.start-time-input').value;
                const end = slotDiv.querySelector('.end-time-input').value;

                if (!start || !end) {
                    hasInvalidTime = true;
                    return;
                }

                // Basic time validation: start time must be before end time
                const startTime = new Date(`2000/01/01T${start}`);
                const endTime = new Date(`2000/01/01T${end}`);
                if (startTime >= endTime) {
                    hasInvalidTime = true;
                    return;
                }

                updatedSchedule.push({ day, start, end });
            });

            if (hasInvalidTime) {
                showCustomAlert('Error', 'Todos los horarios deben tener una hora de inicio y fin v√°lidas, y la hora de inicio debe ser anterior a la hora de fin.');
                return;
            }

            const targetSemester = subjectsData.find(s => s.year === year && s.semester === semester);

            if (subjectId) { // Editing existing subject
                const result = findSubjectAndSemesterById(subjectId);
                if (result) {
                    const { subject } = result;
                    subject.name = newName;
                    subject.credits = newCredits;
                    subject.type = newType;
                    subject.deliveryType = newDeliveryType;
                    subject.scheduleCode = newScheduleCode; // Save schedule code
                    subject.schedule = updatedSchedule;
                    subject.previas = selectedPrevias; // Save previas
                    // Ensure grade and exam status fields are present, but not modified here
                    if (subject.partial1Grade === undefined) subject.partial1Grade = '';
                    if (subject.partial2Grade === undefined) subject.partial2Grade = '';
                    if (subject.finalAverageGrade === undefined) subject.finalAverageGrade = '';
                    if (subject.examStatus === undefined) subject.examStatus = 'No Definido';
                    if (subject.examDate === undefined) subject.examDate = '';
                    if (subject.partial1Date === undefined) subject.partial1Date = '';
                    if (subject.partial2Date === undefined) subject.partial2Date = '';
                    // Ensure time fields are present
                    if (subject.partial1Time === undefined) subject.partial1Time = '';
                    if (subject.partial2Time === undefined) subject.partial2Time = '';
                    if (subject.examTime === undefined) subject.examTime = '';
                    // Ensure professor, zoomUrl, classroom fields are present, but not modified here
                    if (subject.professor === undefined) subject.professor = '';
                    if (subject.zoomUrl === undefined) subject.zoomUrl = '';
                    if (subject.classroom === undefined) subject.classroom = '';
                }
            } else { // Adding new subject
                const newSubject = {
                    id: generateUniqueId(), // Generate a new unique ID
                    name: newName,
                    credits: newCredits,
                    type: newType,
                    deliveryType: newDeliveryType,
                    scheduleCode: newScheduleCode, // Save schedule code
                    partial1Grade: '', // Initialize empty
                    partial2Grade: '', // Initialize empty
                    finalAverageGrade: '', // Initialize empty
                    examStatus: 'No Definido', // Initialize default
                    examDate: '', // Initialize empty
                    partial1Date: '', // Initialize empty
                    partial2Date: '', // Initialize empty
                    partial1Time: '', // Initialize empty
                    partial2Time: '', // Initialize empty
                    examTime: '', // Initialize empty
                    schedule: updatedSchedule,
                    previas: selectedPrevias, // Save previas
                    professor: '', // Initialize empty
                    zoomUrl: '', // Initialize empty
                    classroom: '' // Initialize empty
                };

                if (targetSemester) {
                    targetSemester.subjects.push(newSubject);
                } else {
                    console.error('Target semester not found for adding new subject:', year, semester);
                }
            }

            // Update overlaps for the affected semester
            if (targetSemester) {
                updateSemesterOverlaps(targetSemester);
            }

            saveSubjectsData(); // Save updated subjects data
            recalculateCompletedCredits(); // Recalculate credits as subject credits might have changed
            saveCompletedSubjects(); // Ensure completed subjects state is saved
            updateProgressBars();
            calculateTotalAvailableCredits(); // Update total available credits
            // Re-render the content for the currently active view to reflect changes
            showContent(currentActiveView);
            renderAcademicCalendar(); // Re-render academic calendar
            renderNotificationBanner(); // Update notifications
            closeEditSubjectModal(); // Close the modal after successful save
        }

        // --- Delete Subjects Modal Functions ---

        /**
         * Opens the modal to select and delete multiple subjects.
         * @param {string} year - The year of the semester.
         * @param {string} semester - The semester name.
         */
        function openDeleteSubjectsModal(year, semester) {
            document.getElementById('deleteModalYear').value = year;
            document.getElementById('deleteModalSemester').value = semester;

            const deleteSubjectList = document.getElementById('deleteSubjectList');
            deleteSubjectList.innerHTML = ''; // Clear previous list

            const targetSemester = subjectsData.find(s => s.year === year && s.semester === semester);
            if (targetSemester && targetSemester.subjects.length > 0) {
                targetSemester.subjects.forEach(subject => {
                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'flex items-center p-2 bg-gray-50 rounded-md cursor-pointer hover:bg-red-100 transition duration-150';
                    subjectDiv.innerHTML = `
                        <span class="text-gray-700 font-semibold">${subject.name}</span>
                        <span class="ml-auto text-gray-500 text-sm">(${subject.credits} cr√©ditos)</span>
                    `;
                    // Attach direct deletion on click
                    subjectDiv.onclick = () => showCustomConfirmation(
                        'Confirmar Eliminaci√≥n',
                        `¬øEst√°s seguro de que quieres eliminar la materia "${subject.name}"?`,
                        () => deleteSubjectImmediately(subject.id, year, semester)
                    );
                    subjectDiv.onkeydown = (event) => {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            subjectDiv.click();
                        }
                    };
                    subjectDiv.setAttribute('role', 'button');
                    subjectDiv.setAttribute('tabindex', '0');
                    subjectDiv.setAttribute('aria-label', `Eliminar materia ${subject.name}`);
                    deleteSubjectList.appendChild(subjectDiv);
                });
            } else {
                deleteSubjectList.innerHTML = '<p class="text-gray-500">No hay materias en este semestre para eliminar.</p>';
            }

            document.getElementById('deleteSubjectsModal').classList.remove('hidden');
        }

        /**
         * Closes the delete subjects modal.
         */
        function closeDeleteSubjectsModal() {
            document.getElementById('deleteSubjectsModal').classList.add('hidden');
        }

        /**
         * Deletes a single subject immediately by its ID.
         * This function is called directly from the delete subjects modal.
         * @param {string} subjectId - The ID of the subject to delete.
         * @param {string} year - The year of the semester.
         * @param {string} semester - The semester name.
         */
        function deleteSubjectImmediately(subjectId, year, semester) {
            let subjectRemoved = false;
            const targetSemester = subjectsData.find(s => s.year === year && s.semester === semester);

            if (targetSemester) {
                const initialLength = targetSemester.subjects.length;
                targetSemester.subjects = targetSemester.subjects.filter(sub => sub.id !== subjectId);
                if (targetSemester.subjects.length < initialLength) {
                    subjectRemoved = true;
                }
            }

            if (subjectRemoved) {
                completedSubjects.delete(subjectId); // Remove from completed subjects if it was there
                saveSubjectsData();
                saveCompletedSubjects(); // Ensure completed subjects state is saved
                recalculateCompletedCredits();
                updateProgressBars();
                calculateTotalAvailableCredits();

                // Update overlaps for the affected semester after deletion
                if (targetSemester) {
                    updateSemesterOverlaps(targetSemester);
                }

                showContent(currentActiveView); // Re-render the current view
                renderAcademicCalendar(); // Update academic calendar
                renderNotificationBanner(); // Update notifications
                closeDeleteSubjectsModal(); // Close the modal after deletion and all updates
            } else {
                console.error('Failed to delete subject with ID:', subjectId + '. Subject not found in data.');
                showCustomAlert('Error', 'No se pudo eliminar la materia. No se encontr√≥ en los datos.');
            }
        }

        // --- Grade and Exam Status Input Modal Functions ---

        /**
         * Opens the modal for entering grades and exam status for a specific subject.
         * @param {string} subjectId - The ID of the subject to edit.
         */
        function openGradeStatusModal(subjectId) {
            const result = findSubjectAndSemesterById(subjectId);
            if (!result) {
                showCustomAlert('Error', 'Materia no encontrada.');
                return;
            }
            const { subject } = result;

            document.getElementById('gradeStatusSubjectId').value = subject.id;

            // Populate dropdowns with conceptual grades
            document.getElementById('inputPartial1Grade').innerHTML = generateConceptualGradeOptions(subject.partial1Grade);
            document.getElementById('inputPartial2Grade').innerHTML = generateConceptualGradeOptions(subject.partial2Grade);
            document.getElementById('inputFinalAverageGrade').innerHTML = generateConceptualGradeOptions(subject.finalAverageGrade);
            document.getElementById('inputExamStatus').value = subject.examStatus;

            // Populate date and time inputs
            document.getElementById('inputPartial1Date').value = subject.partial1Date;
            document.getElementById('inputPartial1Time').value = subject.partial1Time;
            document.getElementById('inputPartial2Date').value = subject.partial2Date;
            document.getElementById('inputPartial2Time').value = subject.partial2Time;
            document.getElementById('inputExamDate').value = subject.examDate;
            document.getElementById('inputExamTime').value = subject.examTime;

            // Populate professor, zoomUrl, classroom
            document.getElementById('inputProfessor').value = subject.professor || '';
            document.getElementById('inputZoomUrl').value = subject.zoomUrl || '';
            document.getElementById('inputClassroom').value = subject.classroom || '';


            // Show/hide exam date/time input based on initial exam status
            toggleExamDateTimeVisibility(subject.examStatus);

            document.getElementById('gradeStatusModal').classList.remove('hidden');
        }

        /**
         * Toggles the visibility of the exam date and time input based on the selected exam status.
         * @param {string} status - The selected exam status ('A Examen', 'Salvada', 'No Definido').
         */
        function toggleExamDateTimeVisibility(status) {
            const examDateTimeContainer = document.getElementById('examDateTimeContainer');
            if (status === 'A Examen') {
                examDateTimeContainer.classList.remove('hidden');
            } else {
                examDateTimeContainer.classList.add('hidden');
                document.getElementById('inputExamDate').value = ''; // Clear exam date if not 'A Examen'
                document.getElementById('inputExamTime').value = ''; // Clear exam time if not 'A Examen'
            }
        }

        /**
         * Saves the grades and exam status from the modal to the subject data.
         */
        function saveGradeStatusChanges() {
            const subjectId = document.getElementById('gradeStatusSubjectId').value;
            const result = findSubjectAndSemesterById(subjectId);
            if (!result) {
                showCustomAlert('Error', 'Materia no encontrada al intentar guardar notas.');
                return;
            }
            const { subject } = result;

            subject.partial1Grade = document.getElementById('inputPartial1Grade').value;
            subject.partial2Grade = document.getElementById('inputPartial2Grade').value;
            subject.finalAverageGrade = document.getElementById('inputFinalAverageGrade').value;
            subject.examStatus = document.getElementById('inputExamStatus').value;

            // Save partial exam dates and times
            subject.partial1Date = document.getElementById('inputPartial1Date').value;
            subject.partial1Time = document.getElementById('inputPartial1Time').value;
            subject.partial2Date = document.getElementById('inputPartial2Date').value;
            subject.partial2Time = document.getElementById('inputPartial2Time').value;

            // Save exam date and time only if status is 'A Examen', otherwise clear them
            if (subject.examStatus === 'A Examen') {
                subject.examDate = document.getElementById('inputExamDate').value;
                subject.examTime = document.getElementById('inputExamTime').value;
            } else {
                subject.examDate = ''; // Clear exam date if not 'A Examen'
                subject.examTime = ''; // Clear exam time if not 'A Examen'
            }

            // Save professor, zoomUrl, classroom
            subject.professor = document.getElementById('inputProfessor').value.trim();
            subject.zoomUrl = document.getElementById('inputZoomUrl').value.trim();
            subject.classroom = document.getElementById('inputClassroom').value.trim();

            // Update completed status based on examStatus
            if (subject.examStatus === 'Salvada') {
                completedSubjects.add(subject.id);
            } else {
                completedSubjects.delete(subject.id);
            }

            saveSubjectsData();
            recalculateCompletedCredits();
            saveCompletedSubjects();
            updateProgressBars();
            showContent(currentActiveView); // Re-render to update checkbox and potentially other displays
            renderAcademicCalendar(); // Update academic calendar
            renderNotificationBanner(); // Update notifications
            closeGradeStatusModal();
        }

        /**
         * Closes the grade and exam status input modal.
         */
        function closeGradeStatusModal() {
            document.getElementById('gradeStatusModal').classList.add('hidden');
        }

        /**
         * Opens the subject information modal and populates it.
         * @param {string} subjectId - The ID of the subject to display.
         */
        function openSubjectInfoModal(subjectId) {
            const result = findSubjectAndSemesterById(subjectId);
            if (!result) {
                showCustomAlert('Error', 'Materia no encontrada.');
                return;
            }
            const { subject } = result;
            const subjectInfoContent = document.getElementById('subjectInfoContent');

            const previasHtml = subject.previas.length > 0 ?
                `<ul class="list-disc list-inside">
                    ${subject.previas.map(previaId => {
                        const previaSubject = getSubjectById(previaId);
                        return `<li>${previaSubject ? previaSubject.name : 'Materia no encontrada'}</li>`;
                    }).join('')}
                </ul>`
                : '<li>Ninguna</li>';

            const scheduleHtml = subject.schedule.length > 0 ?
                `<ul class="list-disc list-inside">
                    ${subject.schedule.map(slot => `<li>${slot.day}: ${slot.start} - ${slot.end}</li>`).join('')}
                </ul>`
                : '<li>No hay horario definido</li>';

            subjectInfoContent.innerHTML = `
                <p><strong class="text-gray-800">Nombre:</strong> ${subject.name}</p>
                <p><strong class="text-gray-800">Cr√©ditos:</strong> ${subject.credits}</p>
                <p><strong class="text-gray-800">Tipo:</strong> ${subject.type}</p>
                <p><strong class="text-gray-800">Modalidad:</strong> ${subject.deliveryType}</p>
                <p><strong class="text-gray-800">C√≥digo Horario:</strong> ${subject.scheduleCode !== null ? subject.scheduleCode : 'N/A'}</p>
                <p><strong class="text-gray-800">Profesor:</strong> ${subject.professor || 'N/A'}</p>
                <p><strong class="text-gray-800">URL Zoom:</strong> ${subject.zoomUrl ? `<a href="${subject.zoomUrl}" target="_blank" class="text-blue-600 hover:underline" aria-label="Abrir enlace de Zoom para ${subject.name}">Enlace</a></p>` : 'N/A'}</p>
                <p><strong class="text-gray-800">Aula:</strong> ${subject.classroom || 'N/A'}</p>
                <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-800">Notas y Fechas:</h3>
                <p><strong class="text-gray-800">Primer Parcial:</strong> ${subject.partial1Grade} ${subject.partial1Date ? `(${new Date(subject.partial1Date + 'T12:00:00').toLocaleDateString('es-ES')}` : ''}${subject.partial1Time ? ` ${subject.partial1Time}` : ''}${subject.partial1Date ? ')' : ''}</p>
                <p><strong class="text-gray-800">Segundo Parcial:</strong> ${subject.partial2Grade} ${subject.partial2Date ? `(${new Date(subject.partial2Date + 'T12:00:00').toLocaleDateString('es-ES')}` : ''}${subject.partial2Time ? ` ${subject.partial2Time}` : ''}${subject.partial2Date ? ')' : ''}</p>
                <p><strong class="text-gray-800">Promedio Final:</strong> ${subject.finalAverageGrade}</p>
                <p><strong class="text-gray-800">Estado Examen:</strong> ${subject.examStatus} ${subject.examDate && subject.examStatus === 'A Examen' ? `(${new Date(subject.examDate + 'T12:00:00').toLocaleDateString('es-ES')}` : ''}${subject.examTime && subject.examStatus === 'A Examen' ? ` ${subject.examTime}` : ''}${subject.examDate && subject.examStatus === 'A Examen' ? ')' : ''}</p>
                <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-800">Materias Previas:</h3>
                ${previasHtml}
                <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-800">Horario Semanal:</h3>
                ${scheduleHtml}
            `;
            document.getElementById('subjectInfoModal').classList.remove('hidden');
        }

        /**
         * Closes the subject information modal.
         */
        function closeSubjectInfoModal() {
            document.getElementById('subjectInfoModal').classList.add('hidden');
        }

        /**
         * Collects academic events (partials, exams) from all subjects.
         * @param {boolean} futureOnly - If true, only returns events from today onwards.
         * @param {number} [month] - Specific month (0-11) for filtering.
         * @param {number} [year] - Specific year for filtering.
         * @returns {Array<Object>} An array of event objects.
         */
        function getAcademicEvents(futureOnly = false, month = null, year = null) {
            const events = [];
            const today = new Date();
            // Set today to noon to avoid timezone issues when comparing with event dates
            today.setHours(12, 0, 0, 0);

            subjectsData.forEach(yearSemester => {
                yearSemester.subjects.forEach(subject => {
                    // Partial 1
                    if (subject.partial1Date) {
                        // Append 'T12:00:00' to ensure Date object is created at noon local time
                        const eventDate = new Date(subject.partial1Date + 'T12:00:00');
                        if ((!futureOnly || eventDate >= today) &&
                            (month === null || eventDate.getMonth() === month) &&
                            (year === null || eventDate.getFullYear() === year)) {
                            events.push({
                                id: `${subject.id}-partial1`,
                                name: subject.name,
                                eventType: 'Primer Parcial',
                                eventDate: subject.partial1Date, // Keep original date string for storage
                                eventTime: subject.partial1Time,
                                professor: subject.professor,
                                zoomUrl: subject.zoomUrl,
                                classroom: subject.classroom
                            });
                        }
                    }
                    // Partial 2
                    if (subject.partial2Date) {
                        // Append 'T12:00:00' to ensure Date object is created at noon local time
                        const eventDate = new Date(subject.partial2Date + 'T12:00:00');
                        if ((!futureOnly || eventDate >= today) &&
                            (month === null || eventDate.getMonth() === month) &&
                            (year === null || eventDate.getFullYear() === year)) {
                            events.push({
                                id: `${subject.id}-partial2`,
                                name: subject.name,
                                eventType: 'Segundo Parcial',
                                eventDate: subject.partial2Date, // Keep original date string for storage
                                eventTime: subject.partial2Time,
                                professor: subject.professor,
                                zoomUrl: subject.zoomUrl,
                                classroom: subject.classroom
                            });
                        }
                    }
                    // Final Exam (only if 'A Examen')
                    if (subject.examStatus === 'A Examen' && subject.examDate) {
                        // Append 'T12:00:00' to ensure Date object is created at noon local time
                        const eventDate = new Date(subject.examDate + 'T12:00:00');
                        if ((!futureOnly || eventDate >= today) &&
                            (month === null || eventDate.getMonth() === month) &&
                            (year === null || eventDate.getFullYear() === year)) {
                            events.push({
                                id: `${subject.id}-exam`,
                                name: subject.name,
                                eventType: 'Examen Final',
                                eventDate: subject.examDate, // Keep original date string for storage
                                eventTime: subject.examTime,
                                professor: subject.professor,
                                zoomUrl: subject.zoomUrl,
                                classroom: subject.classroom
                            });
                        }
                    }
                });
            });
            // Sort events by date and then by time
            events.sort((a, b) => {
                // Use the T12:00:00 trick for sorting as well, for consistency
                const dateA = new Date(a.eventDate + (a.eventTime ? `T${a.eventTime}` : 'T12:00:00'));
                const dateB = new Date(b.eventDate + (b.eventTime ? `T${b.eventTime}` : 'T12:00:00'));
                return dateA - dateB;
            });
            return events;
        }

        // --- Academic Calendar Functions (renamed from Exam Calendar) ---
        /**
         * Populates the year selection dropdown for the calendar.
         */
        function populateCalendarYearSelect() {
            const calendarYearSelect = document.getElementById('calendarYearSelect');
            calendarYearSelect.innerHTML = ''; // Clear existing options

            const currentYear = new Date().getFullYear();
            const startYear = currentYear - 5; // 5 years back
            const endYear = currentYear + 5;   // 5 years forward

            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentCalendarDate.getFullYear()) {
                    option.selected = true;
                }
                calendarYearSelect.appendChild(option);
            }

            calendarYearSelect.onchange = (event) => {
                currentCalendarDate.setFullYear(parseInt(event.target.value));
                renderAcademicCalendar();
            };
        }

        /**
         * Renders the academic calendar grid for the current month/year, including partial and final exams.
         */
        function renderAcademicCalendar() {
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = ''; // Clear previous calendar

            const currentMonth = currentCalendarDate.getMonth();
            const currentYear = currentCalendarDate.getFullYear();

            document.getElementById('currentMonthYear').textContent = currentCalendarDate.toLocaleString('es-ES', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();

            const firstDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday

            const daysOfWeek = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

            // Add day headers
            daysOfWeek.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            // Add empty divs for leading blank days
            // Adjust for Sunday being 0, Monday 1...
            const startOffset = (firstDayOfWeek === 0) ? 6 : firstDayOfWeek - 1; // If Sunday, 6 empty days for previous week. Otherwise, firstDayOfWeek - 1.
            for (let i = 0; i < startOffset; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }

            // Group academic events by date for the current month
            const academicEventsForMonth = getAcademicEvents(false, currentMonth, currentYear);
            const academicEventsByDate = {}; // 'YYYY-MM-DD' -> [{event1}, {event2}]
            academicEventsForMonth.forEach(event => {
                const dateKey = event.eventDate; // Already in YYYY-MM-DD format
                if (!academicEventsByDate[dateKey]) {
                    academicEventsByDate[dateKey] = [];
                }
                academicEventsByDate[dateKey].push(event);
            });

            // Add days of the month
            for (let day = 1; day <= numDaysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'calendar-day';
                dayDiv.textContent = day;

                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                if (academicEventsByDate[dateString] && academicEventsByDate[dateString].length > 0) {
                    dayDiv.classList.add('has-exam'); // Use has-exam for any event
                    const eventCount = document.createElement('div');
                    eventCount.className = 'exam-indicator';
                    eventCount.textContent = academicEventsByDate[dateString].length; // Total count of events
                    dayDiv.appendChild(eventCount);
                    dayDiv.onclick = () => openAcademicDetailsModalForDay(dateString, academicEventsByDate[dateString]);
                    dayDiv.setAttribute('role', 'button');
                    dayDiv.setAttribute('tabindex', '0');
                    dayDiv.setAttribute('aria-label', `Ver eventos para el d√≠a ${day} de ${currentCalendarDate.toLocaleString('es-ES', { month: 'long' })}`);
                    dayDiv.onkeydown = (event) => {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            dayDiv.click();
                        }
                    };
                } else {
                    dayDiv.onclick = () => showCustomAlert('Sin Eventos', `No hay eventos programados para el ${day}/${currentMonth + 1}/${currentYear}.`);
                    dayDiv.setAttribute('role', 'button');
                    dayDiv.setAttribute('tabindex', '0');
                    dayDiv.setAttribute('aria-label', `No hay eventos para el d√≠a ${day} de ${currentCalendarDate.toLocaleString('es-ES', { month: 'long' })}`);
                    dayDiv.onkeydown = (event) => {
                        if (event.key === 'Enter' || event.key === ' ') {
                            event.preventDefault();
                            dayDiv.click();
                        }
                    };
                }
                calendarGrid.appendChild(dayDiv);
            }
        }

        /**
         * Navigates the calendar to the previous month.
         */
        function prevMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            renderAcademicCalendar();
        }

        /**
         * Navigates the calendar to the next month.
         */
        function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            renderAcademicCalendar();
        }

        /**
         * Opens the modal to display academic event details for a selected date.
         * This version is specifically for a single day's events from the calendar.
         * @param {string} dateString - The date in YYYY-MM-DD format.
         * @param {object[]} events - An array of event objects for that date.
         */
        function openAcademicDetailsModalForDay(dateString, events) {
            // Append 'T12:00:00' to the date string to ensure correct date interpretation
            document.getElementById('academicDateDisplay').textContent = `Eventos para el ${new Date(dateString + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;
            const eventsForSelectedDate = document.getElementById('eventsForSelectedDate');
            eventsForSelectedDate.innerHTML = '';

            if (events && events.length > 0) {
                events.forEach(event => {
                    const eventDetailDiv = document.createElement('div');
                    eventDetailDiv.className = 'p-3 bg-gray-100 rounded-md shadow-sm';
                    eventDetailDiv.innerHTML = `
                        <p class="font-semibold text-lg">${event.name} - ${event.eventType} ${event.eventTime ? `(${event.eventTime})` : ''}</p>
                        <p class="text-sm text-gray-600">Profesor: ${event.professor || 'N/A'}</p>
                        ${event.zoomUrl ? `<p class="text-sm text-gray-600">Zoom: <a href="${event.zoomUrl}" target="_blank" class="text-blue-600 hover:underline" aria-label="Abrir enlace de Zoom para ${event.name}">Enlace</a></p>` : ''}
                        ${event.classroom ? `<p class="text-sm text-gray-600">Aula: ${event.classroom}</p>` : ''}
                    `;
                    eventsForSelectedDate.appendChild(eventDetailDiv);
                });
            } else {
                eventsForSelectedDate.innerHTML = '<p class="text-gray-500">No hay eventos programados para esta fecha.</p>';
            }
            document.getElementById('academicDetailsModal').classList.remove('hidden');
        }

        // --- Share Schedule (PDF Generation) Functions ---

        /**
         * Shows the loading overlay.
         */
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        /**
         * Hides the loading overlay.
         */
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        /**
         * Creates a temporary schedule table element for PDF generation.
         * @param {object} semesterData - The data for the semester.
         * @returns {HTMLElement} The created table element.
         */
        function createScheduleTableElement(semesterData) {
            const table = document.createElement('table');
            // Apply specific styles for PDF rendering to ensure it fits
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.margin = '0';
            table.style.boxShadow = 'none';
            table.style.fontSize = '0.7em'; /* Smaller font for PDF */
            table.style.tableLayout = 'fixed'; /* Fixed layout for even column distribution */

            table.innerHTML = `
                <thead>
                    <tr>
                        <th style="width: 12%;">Hora</th>
                        <th style="width: 12.5%;">Lunes</th>
                        <th style="width: 12.5%;">Martes</th>
                        <th style="width: 12.5%;">Mi√©rcoles</th>
                        <th style="width: 12.5%;">Jueves</th>
                        <th style="width: 12.5%;">Viernes</th>
                        <th style="width: 12.5%;">S√°bado</th>
                        <th style="width: 12.5%;">Domingo</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Schedule rows will be populated by JS -->
                </tbody>
            `;
            // Populate the table using the existing logic
            // The populateScheduleTable function will also apply its own styles,
            // so we need to ensure the most specific ones (for PDF) take precedence.
            // For this, we'll apply them directly to the cells after population.

            const tableBody = table.querySelector('tbody');
            const timeSlots = {};

            // Define fixed time intervals from 8:00 to 23:00
            const fixedIntervals = [];
            for (let h = 8; h < 23; h++) {
                const start = `${String(h).padStart(2, '0')}:00`;
                const end = `${String(h + 1).padStart(2, '0')}:00`;
                fixedIntervals.push({ start, end });
            }

            fixedIntervals.forEach(interval => {
                const slotKey = `${interval.start}-${interval.end}`;
                timeSlots[slotKey] = {
                    display: `${interval.start} - ${interval.end}`,
                    days: { 'Lunes': [], 'Martes': [], 'Mi√©rcoles': [], 'Jueves': [], 'Viernes': [], 'S√°bado': [], 'Domingo': [] }
                };
            });

            semesterData.subjects.forEach(subject => {
                subject.schedule.forEach(slot => {
                    const subjectStartTime = slot.start;
                    const subjectEndTime = slot.end;
                    const subjectDay = slot.day;

                    fixedIntervals.forEach(interval => {
                        const intervalStart = interval.start;
                        const intervalEnd = interval.end;

                        if (subjectStartTime < intervalEnd && subjectEndTime > intervalStart) {
                            const slotKey = `${intervalStart}-${intervalEnd}`;
                            if (timeSlots[slotKey] && timeSlots[slotKey].days[subjectDay]) {
                                timeSlots[slotKey].days[subjectDay].push({
                                    id: subject.id,
                                    name: subject.name,
                                    type: subject.type,
                                    scheduleCode: subject.scheduleCode,
                                    start: subjectStartTime,
                                    end: subjectEndTime
                                });
                            }
                        }
                    });
                });
            });

            updateSemesterOverlaps(semesterData); // Re-calculate overlaps for this specific semester data for PDF

            for (const slotKey in timeSlots) {
                const row = document.createElement('tr');
                row.innerHTML = `<td class="schedule-time" style="padding: 0.2rem; border: 1px solid #f0e0f0;">${timeSlots[slotKey].display}</td>`; // Apply inline style

                const daysOfWeek = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];
                daysOfWeek.forEach(day => {
                    const cell = document.createElement('td');
                    cell.style.padding = '0.2rem'; // Apply inline style
                    cell.style.border = '1px solid #f0e0f0'; // Apply inline style
                    cell.style.verticalAlign = 'top'; // Ensure top alignment
                    cell.style.textAlign = 'center'; // Center text

                    const entries = timeSlots[slotKey].days[day];
                    const uniqueEntries = Array.from(new Set(entries.map(e => JSON.stringify(e))))
                                                .map(e => JSON.parse(e));

                    uniqueEntries.forEach(entry => {
                        const entryDiv = document.createElement('div');
                        const originalSubject = semesterData.subjects.find(s => s.id === entry.id);
                        const originalSlot = originalSubject ? originalSubject.schedule.find(s => s.day === day && s.start === entry.start && s.end === entry.end) : null;
                        const isOverlap = originalSlot ? originalSlot.overlap : false;

                        // Apply class-based styles and then override with inline for PDF specificity
                        let entryBgColor = '';
                        let entryTextColor = '#333';
                        if (entry.type === 'Obligatoria') entryBgColor = '#ffc080';
                        else if (entry.type === 'Opcional') entryBgColor = '#c0e0c0';
                        else if (entry.type === 'Electiva') entryBgColor = '#f8bbd0';

                        if (isOverlap) {
                            entryTextColor = '#8b0000'; // Dark red for overlap text
                            entryBgColor = 'transparent'; // No background for overlap
                        }

                        entryDiv.style.borderRadius = '0.2rem';
                        entryDiv.style.padding = '0.1rem';
                        entryDiv.style.margin = '0.05rem 0';
                        entryDiv.style.fontSize = '0.7em'; /* Even smaller font for PDF entries */
                        entryDiv.style.lineHeight = '1.1';
                        entryDiv.style.color = entryTextColor;
                        entryDiv.style.backgroundColor = entryBgColor;
                        entryDiv.style.boxShadow = '0 0.5px 1px rgba(0,0,0,0.1)';
                        entryDiv.style.fontWeight = isOverlap ? 'bold' : 'normal';
                        entryDiv.style.textAlign = 'center';


                        entryDiv.textContent = entry.name;
                        if (entry.scheduleCode !== null) {
                            entryDiv.textContent += ` (Cod: ${entry.scheduleCode})`;
                        }
                        cell.appendChild(entryDiv);
                    });
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            }

            return table;
        }


        /**
         * Generates a PDF of the academic schedule.
         */
        async function generatePdf() {
            showLoadingOverlay();
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for A4 size

            const selectedYear = document.getElementById('shareYearSelect').value;
            const selectedSemester = document.getElementById('shareSemesterSelect').value;

            if (!selectedYear || !selectedSemester) {
                showCustomAlert('Error', 'Por favor, selecciona un a√±o y un semestre para generar el horario.');
                hideLoadingOverlay();
                return;
            }

            const semesterDataToPrint = subjectsData.find(s => s.year === selectedYear && s.semester === selectedSemester);

            if (!semesterDataToPrint) {
                showCustomAlert('Error', 'No se encontraron datos para el a√±o y semestre seleccionados.');
                hideLoadingOverlay();
                return;
            }

            // Create a temporary container for the schedule table
            const tempContainer = document.createElement('div');
            tempContainer.style.position = 'absolute';
            tempContainer.style.left = '-9999px'; // Move off-screen
            tempContainer.style.width = '210mm'; // A4 width
            tempContainer.style.padding = '10mm'; // Add some padding for rendering
            document.body.appendChild(tempContainer);

            // Add a title to the temporary container for the PDF
            const pdfTitle = document.createElement('h2');
            pdfTitle.textContent = `Horario Semanal - ${selectedYear} ${selectedSemester} Semestre`;
            pdfTitle.style.textAlign = 'center';
            pdfTitle.style.marginBottom = '10mm';
            pdfTitle.style.fontSize = '20px';
            pdfTitle.style.fontFamily = 'Inter, sans-serif';
            tempContainer.appendChild(pdfTitle);

            const scheduleTableElement = createScheduleTableElement(semesterDataToPrint);
            tempContainer.appendChild(scheduleTableElement);

            try {
                const canvas = await html2canvas(tempContainer, { scale: 2 }); // Increase scale for better resolution
                const imgData = canvas.toDataURL('image/png');

                const imgWidth = doc.internal.pageSize.width - 20; // Page width minus 10mm margin on each side
                const pageHeight = doc.internal.pageSize.height;
                let imgHeight = (canvas.height * imgWidth) / canvas.width;

                let yPosition = 10; // Initial Y position with 10mm top margin

                // If the image height is greater than the page height, scale it down to fit
                if (imgHeight > pageHeight - 20) { // 20mm for top/bottom margins
                    const scaleFactor = (pageHeight - 20) / imgHeight;
                    imgWidth *= scaleFactor;
                    imgHeight = pageHeight - 20;
                    // Recalculate x position to center the scaled image
                    const xPosition = (doc.internal.pageSize.width - imgWidth) / 2;
                    doc.addImage(imgData, 'PNG', xPosition, yPosition, imgWidth, imgHeight);
                } else {
                    // Center the image if it fits
                    const xPosition = (doc.internal.pageSize.width - imgWidth) / 2;
                    doc.addImage(imgData, 'PNG', xPosition, yPosition, imgWidth, imgHeight);
                }

                doc.save(`${careerSettings.careerTitle}-${selectedYear}-${selectedSemester}-Horario.pdf`);

            } catch (error) {
                console.error('Error generating PDF:', error);
                showCustomAlert('Error', 'Hubo un problema al generar el PDF. Int√©ntalo de nuevo.');
            } finally {
                document.body.removeChild(tempContainer); // Clean up the temporary element
                hideLoadingOverlay();
                closeShareScheduleModal();
            }
        }

        /**
         * Populates the year and semester dropdowns in the share schedule modal.
         */
        function populateShareModalDropdowns() {
            const shareYearSelect = document.getElementById('shareYearSelect');
            const shareSemesterSelect = document.getElementById('shareSemesterSelect');

            shareYearSelect.innerHTML = '<option value="">Selecciona A√±o</option>';
            shareSemesterSelect.innerHTML = '<option value="">Selecciona Semestre</option>';

            const uniqueYears = [...new Set(subjectsData.map(data => data.year))].sort((a, b) => {
                const getYearNumber = (yearName) => {
                    const match = yearName.match(/\d+/);
                    return match ? parseInt(match[0]) : Infinity;
                };
                return getYearNumber(a) - getYearNumber(b);
            });

            uniqueYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                shareYearSelect.appendChild(option);
            });

            // Event listener for year select change to populate semesters
            shareYearSelect.onchange = () => {
                const selectedYear = shareYearSelect.value;
                shareSemesterSelect.innerHTML = '<option value="">Selecciona Semestre</option>';
                if (selectedYear) {
                    const semestersInSelectedYear = subjectsData.filter(data => data.year === selectedYear)
                                                                .map(data => data.semester)
                                                                .sort((a, b) => romanSemesterToInt(a) - romanSemesterToInt(b));
                    semestersInSelectedYear.forEach(semester => {
                        const option = document.createElement('option');
                        option.value = semester;
                        option.textContent = semester;
                        shareSemesterSelect.appendChild(option);
                    });
                }
            };

            // Set initial selected values if a year is already active in the main view
            if (currentActiveView && currentActiveView !== 'Calendario Lectivo') {
                shareYearSelect.value = currentActiveView;
                // Manually trigger onchange to populate semesters for the initially selected year
                const event = new Event('change');
                shareYearSelect.dispatchEvent(event);
            }
        }


        /**
         * Opens the share schedule modal.
         */
        function openShareScheduleModal() {
            populateShareModalDropdowns(); // Populate dropdowns every time the modal opens
            document.getElementById('shareScheduleModal').classList.remove('hidden');
        }

        /**
         * Closes the share schedule modal.
         */
        function closeShareScheduleModal() {
            document.getElementById('shareScheduleModal').classList.add('hidden');
        }

        // --- Custom Alert/Confirmation Modal Functions ---

        /**
         * Displays a custom alert message.
         * @param {string} title - The title of the alert.
         * @param {string} message - The message to display.
         */
        function showCustomAlert(title, message) {
            const modal = document.getElementById('customAlertModal');
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            document.getElementById('alertModalConfirmBtn').classList.add('hidden'); // Hide confirm button for alerts
            modal.classList.remove('hidden');
            // Set focus to the close button for accessibility
            document.getElementById('alertModalCloseBtn').focus();
        }

        /**
         * Displays a custom confirmation dialog.
         * @param {string} title - The title of the confirmation.
         * @param {string} message - The message to display.
         * @param {function} onConfirm - Callback function to execute if confirmed.
         */
        function showCustomConfirmation(title, message, onConfirm) {
            const modal = document.getElementById('customAlertModal');
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            document.getElementById('alertModalConfirmBtn').classList.remove('hidden'); // Show confirm button for confirmations

            // Set up event listeners for confirmation
            document.getElementById('alertModalConfirmBtn').onclick = () => {
                onConfirm();
                modal.classList.add('hidden');
            };
            modal.classList.remove('hidden');
            // Set focus to the confirm button for accessibility
            document.getElementById('alertModalConfirmBtn').focus();
        }

        /**
         * Closes the custom alert/confirmation modal.
         */
        function closeCustomAlertModal() {
            document.getElementById('customAlertModal').classList.add('hidden');
            // Remove specific confirmation handler to prevent unintended calls
            document.getElementById('alertModalConfirmBtn').onclick = null;
        }

        // --- New Chart and Daily Load Calculation/Rendering Functions ---

        /**
         * Calculates the total weekly hours for a single subject based on its schedule.
         * @param {object} subject - The subject object.
         * @returns {number} Total weekly hours.
         */
        function calculateSubjectWeeklyHours(subject) {
            let totalHours = 0;
            subject.schedule.forEach(slot => {
                // Parse times and calculate duration in hours
                const [startHour, startMinute] = slot.start.split(':').map(Number);
                const [endHour, endMinute] = slot.end.split(':').map(Number);

                const startTimeInMinutes = startHour * 60 + startMinute;
                const endTimeInMinutes = endHour * 60 + endMinute;

                let durationMinutes = endTimeInMinutes - startTimeInMinutes;
                if (durationMinutes < 0) { // Handle cases where end time is on the next day (e.g., 23:00 - 01:00)
                    durationMinutes += 24 * 60;
                }
                totalHours += durationMinutes / 60; // Convert minutes to hours
            });
            return totalHours;
        }

        /**
         * Calculates the total weekly hours for each subject type within a semester.
         * @param {object[]} semesterSubjects - Array of subject objects for a semester.
         * @returns {object} An object with total hours per type (Obligatoria, Opcional, Electiva).
         */
        function getSemesterTypeHours(semesterSubjects) {
            const typeHours = {
                'Obligatoria': 0,
                'Opcional': 0,
                'Electiva': 0
            };
            semesterSubjects.forEach(subject => {
                const hours = calculateSubjectWeeklyHours(subject);
                if (typeHours.hasOwnProperty(subject.type)) {
                    typeHours[subject.type] += hours;
                }
            });
            return typeHours;
        }

        /**
         * Calculates the total daily hours for a semester.
         * @param {object[]} semesterSubjects - Array of subject objects for a semester.
         * @returns {object} An object with total hours per day of the week.
         */
        function getSemesterDailyHours(semesterSubjects) {
            const dailyHours = {
                'Lunes': 0,
                'Martes': 0,
                'Mi√©rcoles': 0,
                'Jueves': 0,
                'Viernes': 0,
                'S√°bado': 0,
                'Domingo': 0
            };
            semesterSubjects.forEach(subject => {
                subject.schedule.forEach(slot => {
                    const [startHour, startMinute] = slot.start.split(':').map(Number);
                    const [endHour, endMinute] = slot.end.split(':').map(Number);

                    const startTimeInMinutes = startHour * 60 + startMinute;
                    const endTimeInMinutes = endHour * 60 + endMinute;

                    let durationMinutes = endTimeInMinutes - startTimeInMinutes;
                    if (durationMinutes < 0) { // Handle cases where end time is on the next day
                        durationMinutes += 24 * 60;
                    }
                    const hours = durationMinutes / 60;

                    if (dailyHours.hasOwnProperty(slot.day)) {
                        dailyHours[slot.day] += hours;
                    }
                });
            });
            return dailyHours;
        }

        /**
         * Calculates the total weekly hours for all subjects in a given array.
         * @param {object[]} subjects - An array of subject objects.
         * @returns {number} The total weekly hours.
         */
        function calculateSemesterTotalWeeklyHours(subjects) {
            let totalHours = 0;
            subjects.forEach(subject => {
                totalHours += calculateSubjectWeeklyHours(subject);
            });
            return totalHours;
        }

        /**
         * Renders a donut chart for weekly load by subject type.
         * @param {string} canvasId - The ID of the canvas element.
         * @param {object} typeHours - Data for the chart (hours per type).
         */
        function renderDonutChart(canvasId, typeHours) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) {
                console.warn(`Canvas with ID ${canvasId} not found for chart rendering.`);
                return;
            }
            const context = ctx.getContext('2d');

            // Destroy existing chart instance if it exists
            if (window.semesterCharts[canvasId]) {
                window.semesterCharts[canvasId].destroy();
            }

            const data = {
                labels: ['Obligatoria', 'Opcional', 'Electiva'],
                datasets: [{
                    data: [typeHours['Obligatoria'], typeHours['Opcional'], typeHours['Electiva']],
                    backgroundColor: [
                        '#ffb060', // Obligatoria - Pastel Orange
                        '#a0d0a0', // Opcional - Pastel Green
                        '#f48fb1'  // Electiva - Pastel Pink
                    ],
                    hoverBackgroundColor: [
                        '#e69540',
                        '#80b080',
                        '#e07090'
                    ],
                    borderWidth: 0
                }]
            };

            window.semesterCharts[canvasId] = new Chart(context, {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#333',
                                font: {
                                    family: 'Inter',
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += context.parsed.toFixed(1) + ' horas';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the daily load boxes for a semester.
         * @param {string} containerId - The ID of the container div.
         * @param {object} dailyHours - Data for daily hours.
         */
        function renderDailyLoadBoxes(containerId, dailyHours) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.warn(`Container with ID ${containerId} not found for daily load boxes.`);
                return;
            }
            container.innerHTML = ''; // Clear previous content

            const daysOrder = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado', 'Domingo'];

            daysOrder.forEach(day => {
                const hours = dailyHours[day] || 0;
                const box = document.createElement('div');
                box.className = 'bg-white p-3 rounded-lg shadow-md text-center flex-1 min-w-[120px]'; // Tailwind classes
                box.innerHTML = `
                    <p class="font-semibold text-gray-700">${day}</p>
                    <p class="text-xl font-bold ${hours > 0 ? 'text-green-600' : 'text-gray-500'}">${hours.toFixed(1)}h</p>
                `;
                container.appendChild(box);
            });
        }


        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial setup
            updateHeaderDisplay();
            recalculateCompletedCredits();
            calculateTotalAvailableCredits();
            renderYearSelectionButtons();
            populateCalendarYearSelect();
            renderAcademicCalendar();
            renderNotificationBanner();

            // Event Listeners for main buttons
            document.getElementById('addYearBtn').onclick = addYear;
            document.getElementById('removeYearBtn').onclick = removeYear;
            document.getElementById('calendarMainButton').onclick = () => {
                // Toggle calendar visibility
                const calendarWrapper = document.getElementById('calendarWrapper');
                const semesterContentArea = document.getElementById('semesterContentArea');
                const calendarMainButton = document.getElementById('calendarMainButton');

                if (calendarWrapper.classList.contains('hidden')) {
                    // Show calendar
                    semesterContentArea.classList.add('hidden'); // Hide semester content
                    calendarWrapper.classList.remove('hidden'); // Show calendar
                    calendarMainButton.classList.add('active'); // Activate calendar button
                    currentActiveView = 'Calendario Lectivo'; // Set active view to calendar
                } else {
                    // Hide calendar and show first year (or default message if no years)
                    calendarWrapper.classList.add('hidden'); // Hide calendar
                    calendarMainButton.classList.remove('active'); // Deactivate calendar button
                    
                    const uniqueYears = [...new Set(subjectsData.map(data => data.year))].sort((a, b) => {
                        const getYearNumber = (yearName) => {
                            const match = yearName.match(/\d+/);
                            return match ? parseInt(match[0]) : Infinity;
                        };
                        return getYearNumber(a) - getYearNumber(b);
                    });

                    if (uniqueYears.length > 0) {
                        showContent(uniqueYears[0]); // Show the first year's content
                    } else {
                        semesterContentArea.classList.remove('hidden'); // Ensure it's visible to show message
                        semesterContentArea.innerHTML = '<p class="text-center text-gray-500 mt-10">No hay a√±os acad√©micos para mostrar. Agrega un nuevo a√±o para empezar.</p>';
                        currentActiveView = ''; // No active view
                    }
                }
                renderYearSelectionButtons(); // Re-render year buttons to update active state
            };

            // Calendar navigation buttons
            document.getElementById('prevMonthBtn').onclick = prevMonth;
            document.getElementById('nextMonthBtn').onclick = nextMonth;
            document.getElementById('closeAcademicDetailsModalBtn').onclick = closeAcademicDetailsModal; // Close button for academic details modal

            // Settings Modal
            document.getElementById('openSettingsModalBtn').onclick = () => {
                document.getElementById('editCareerTitle').value = careerSettings.careerTitle;
                document.getElementById('editTotalCareerCredits').value = careerSettings.totalCareerCredits;
                document.getElementById('editIntermediateTitleCredits').value = careerSettings.intermediateTitleCredits;
                document.getElementById('settingsModal').classList.remove('hidden');
            };
            document.getElementById('saveSettingsBtn').onclick = () => {
                const newTitle = document.getElementById('editCareerTitle').value.trim();
                const newTotalCredits = parseInt(document.getElementById('editTotalCareerCredits').value);
                const newIntermediateCredits = parseInt(document.getElementById('editIntermediateTitleCredits').value);

                if (!newTitle) {
                    showCustomAlert('Error', 'El t√≠tulo de la carrera no puede estar vac√≠o.');
                    return;
                }
                if (isNaN(newTotalCredits) || newTotalCredits <= 0) {
                    showCustomAlert('Error', 'Los cr√©ditos totales deben ser un n√∫mero positivo.');
                    return;
                }
                if (isNaN(newIntermediateCredits) || newIntermediateCredits < 0) { // Intermediate can be 0 or more
                    showCustomAlert('Error', 'Los cr√©ditos para el t√≠tulo intermedio deben ser un n√∫mero positivo o cero.');
                    return;
                }

                careerSettings.careerTitle = newTitle;
                careerSettings.totalCareerCredits = newTotalCredits;
                careerSettings.intermediateTitleCredits = newIntermediateCredits;
                saveCareerSettings();
                updateHeaderDisplay();
                closeSettingsModal();
            };
            document.getElementById('cancelSettingsBtn').onclick = closeSettingsModal;
            function closeSettingsModal() {
                document.getElementById('settingsModal').classList.add('hidden');
            }

            // Subject Editing/Adding Modal
            document.getElementById('addScheduleSlotBtn').onclick = () => addScheduleSlotToModal();
            document.getElementById('saveSubjectBtn').onclick = saveSubjectChanges;
            document.getElementById('cancelSubjectBtn').onclick = closeEditSubjectModal;

            // Delete Subjects Modal
            document.getElementById('cancelDeleteSubjectsBtn').onclick = closeDeleteSubjectsModal;

            // Custom Alert/Confirmation Modal
            document.getElementById('alertModalCloseBtn').onclick = closeCustomAlertModal;

            // Grade Status Modal
            document.getElementById('inputExamStatus').onchange = (event) => toggleExamDateTimeVisibility(event.target.value);
            document.getElementById('saveGradeStatusBtn').onclick = saveGradeStatusChanges;
            document.getElementById('cancelGradeStatusBtn').onclick = closeGradeStatusModal;

            // Subject Info Modal
            document.getElementById('closeSubjectInfoModalBtn').onclick = closeSubjectInfoModal;

            // Share Schedule Modal
            document.getElementById('openShareScheduleModalBtn').onclick = openShareScheduleModal;
            document.getElementById('cancelShareScheduleBtn').onclick = closeShareScheduleModal;
            document.getElementById('generatePdfBtn').onclick = generatePdf; // No longer needs pdfOption parameter

            // Previa filter event listeners
            document.getElementById('filterPreviaYear').onchange = (event) => {
                const currentSubjectId = document.getElementById('editSubjectId').value;
                const selectedYear = event.target.value;
                const selectedSemester = document.getElementById('filterPreviaSemester').value;
                populatePreviaFilters(currentSubjectId, selectedYear, selectedSemester); // Re-populate semesters based on new year
                populatePreviasDropdown(currentSubjectId, [], selectedYear, selectedSemester); // Re-populate previas
            };
            document.getElementById('filterPreviaSemester').onchange = (event) => {
                const currentSubjectId = document.getElementById('editSubjectId').value;
                const selectedYear = document.getElementById('filterPreviaYear').value;
                const selectedSemester = event.target.value;
                populatePreviasDropdown(currentSubjectId, [], selectedYear, selectedSemester); // Re-populate previas
            };
        });
    </script>

